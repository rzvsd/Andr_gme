var xe=r=>{throw TypeError(r)};var ei=(r,t,e)=>t.has(r)||xe("Cannot "+e);var L=(r,t,e)=>t.has(r)?xe("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e);var f=(r,t,e)=>(ei(r,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var Pt,de;class ce{constructor(t,e){L(this,Pt);this.viewportWidth=1,this.viewportHeight=1,this.x=0,this.y=0,this.target=null,this.lerpFactor=.1,this.setViewport(t,e)}setViewport(t,e){const s=Number(t),i=Number(e);this.viewportWidth=Number.isFinite(s)&&s>0?s:1,this.viewportHeight=Number.isFinite(i)&&i>0?i:1}follow(t,e=.1){this.target=t??null;const s=Number(e);Number.isFinite(s)&&(this.lerpFactor=Math.min(1,Math.max(0,s)))}update(){if(!this.target)return;const t=f(this,Pt,de).call(this,"width","w"),e=f(this,Pt,de).call(this,"height","h"),s=this.target.x+t/2-this.viewportWidth/2,i=this.target.y+e/2-this.viewportHeight/2;this.x+=(s-this.x)*this.lerpFactor,this.y+=(i-this.y)*this.lerpFactor}worldToScreen(t,e,s){const i=s&&typeof s=="object"?s:{};return i.x=Number(t)-this.x,i.y=Number(e)-this.y,i}screenToWorld(t,e,s){const i=s&&typeof s=="object"?s:{};return i.x=Number(t)+this.x,i.y=Number(e)+this.y,i}}Pt=new WeakSet,de=function(t,e){var n,o;const s=Number((n=this.target)==null?void 0:n[t]);if(Number.isFinite(s))return s;const i=Number((o=this.target)==null?void 0:o[e]);return Number.isFinite(i)?i:0};var Gt,Ss;class si{constructor(){L(this,Gt);this.events=new Map,this._handlingError=!1}on(t,e){if(typeof e!="function")return()=>{};const s=this.events.get(t)??new Set;return s.add(e),this.events.set(t,s),()=>this.off(t,e)}off(t,e){const s=this.events.get(t);s&&(s.delete(e),s.size===0&&this.events.delete(t))}emit(t,e){const s=this.events.get(t);if(!(!s||s.size===0))for(const i of[...s])try{i(e)}catch(n){f(this,Gt,Ss).call(this,t,i,e,n)}}}Gt=new WeakSet,Ss=function(t,e,s,i){if(this._handlingError){console.error("[EventBus] Nested handler error.",i);return}const n={eventName:t,handler:e,payload:s,error:i},o=this.events.get("eventbus:error");if(!o||o.size===0){console.error("[EventBus] Handler threw while emitting event.",n);return}this._handlingError=!0;try{for(const h of[...o])try{h(n)}catch(a){console.error("[EventBus] Error handler threw.",a)}}finally{this._handlingError=!1}};const ke={ArrowLeft:"left",KeyA:"left",ArrowRight:"right",KeyD:"right",Space:"jump",ArrowUp:"jump",KeyW:"jump",KeyJ:"shoot",KeyK:"shoot",KeyX:"shoot"},Ce=12,ii=32;class ni{constructor(){this.attached=!1,this.touchControlsEnabled=!0,this.keyboardState={left:!1,right:!1,jump:!1,shoot:!1},this.touchState={left:!1,right:!1,shoot:!1},this.pressedState={jump:!1,shoot:!1},this.leftTouch=null,this.rightTouchId=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)}clearTouchState(){this.touchState.left=!1,this.touchState.right=!1,this.touchState.shoot=!1,this.leftTouch=null,this.rightTouchId=null}setTouchControlsEnabled(t){this.touchControlsEnabled=t!==!1,this.touchControlsEnabled||this.clearTouchState()}attach(){this.attached||(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),window.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),window.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),window.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),window.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1}),this.attached=!0)}detach(){this.attached&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("touchstart",this.handleTouchStart),window.removeEventListener("touchmove",this.handleTouchMove),window.removeEventListener("touchend",this.handleTouchEnd),window.removeEventListener("touchcancel",this.handleTouchEnd),this.keyboardState.left=!1,this.keyboardState.right=!1,this.keyboardState.jump=!1,this.keyboardState.shoot=!1,this.clearTouchState(),this.attached=!1)}isPressed(t){return t==="left"?this.keyboardState.left||this.touchState.left:t==="right"?this.keyboardState.right||this.touchState.right:t==="jump"?this.keyboardState.jump:t==="shoot"?this.keyboardState.shoot||this.touchState.shoot:!1}consumePressed(t){if(t!=="jump"&&t!=="shoot")return!1;const e=this.pressedState[t];return this.pressedState[t]=!1,e}handleKeyDown(t){const e=ke[t.code];e&&(this.keyboardState[e]||(this.keyboardState[e]=!0,(e==="jump"||e==="shoot")&&(this.pressedState[e]=!0)))}handleKeyUp(t){const e=ke[t.code];e&&(this.keyboardState[e]=!1)}handleTouchStart(t){if(!this.touchControlsEnabled)return;let e=!1;const s=window.innerWidth/2;for(const i of t.changedTouches)i.clientX<=s?this.leftTouch||(this.leftTouch={id:i.identifier,startX:i.clientX,startY:i.clientY,jumpTriggered:!1},this.touchState.left=!1,this.touchState.right=!1,e=!0):this.rightTouchId===null&&(this.rightTouchId=i.identifier,this.touchState.shoot=!0,this.pressedState.shoot=!0,e=!0);e&&t.cancelable&&t.preventDefault()}handleTouchMove(t){if(!this.touchControlsEnabled)return;let e=!1;for(const s of t.changedTouches){if(this.leftTouch&&s.identifier===this.leftTouch.id){const i=s.clientX-this.leftTouch.startX,n=this.leftTouch.startY-s.clientY;i<=-Ce?(this.touchState.left=!0,this.touchState.right=!1):i>=Ce?(this.touchState.left=!1,this.touchState.right=!0):(this.touchState.left=!1,this.touchState.right=!1),!this.leftTouch.jumpTriggered&&n>=ii&&(this.leftTouch.jumpTriggered=!0,this.pressedState.jump=!0),e=!0}this.rightTouchId!==null&&s.identifier===this.rightTouchId&&(this.touchState.shoot=!0,e=!0)}e&&t.cancelable&&t.preventDefault()}handleTouchEnd(t){if(!this.touchControlsEnabled)return;let e=!1;for(const s of t.changedTouches)this.leftTouch&&s.identifier===this.leftTouch.id&&(this.leftTouch=null,this.touchState.left=!1,this.touchState.right=!1,e=!0),this.rightTouchId!==null&&s.identifier===this.rightTouchId&&(this.rightTouchId=null,this.touchState.shoot=!1,e=!0);e&&t.cancelable&&t.preventDefault()}}const ri="#0b1020",oi=60,Fe=1600,Le=360,hi=2400,ai=2200,_s=25,fe="#4fc3f7",pe="#0c2b3a",li="#81a84d",ui="#3a2b12",dt=Object.freeze({GRUNT:"#cf5f5f",SNIPER:"#7b9bcf",RUSHER:"#d18f4f",TANK:"#6d8a5d",BOSS:"#8f58b5"}),ot=.12;class ci{constructor(t){if(!(t instanceof HTMLCanvasElement))throw new Error("Game requires an HTMLCanvasElement.");const e=t.getContext("2d");if(!e)throw new Error("2D rendering context is not available.");this.canvas=t,this.ctx=e,this.running=!1,this.rafId=null,this.lastTime=0,this.accumulator=0,this.ups=oi,this.fixedStepMs=1e3/this.ups,this.viewWidth=1,this.viewHeight=1,this.dpr=1,this.eventBus=new si,this.input=new ni,this.camera=new ce(this.viewWidth,this.viewHeight),this.scenes=new Map,this.currentSceneName=null,this.currentScene=null,this.sceneData={},this.loop=this.loop.bind(this),this.handleResize=this.handleResize.bind(this),this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),this.handlePointerCancel=this.handlePointerCancel.bind(this)}registerScene(t,e){if(typeof t!="string"||t.trim().length===0||e==null)throw new Error("registerScene(name, scene) requires a non-empty scene name and object.");return this.scenes.set(t,e),e}switchScene(t,e=void 0){if(!this.scenes.has(t))return!1;const s=this.scenes.get(t),i=this.currentScene,n=this.currentSceneName,o={from:n,to:t,payload:e};if(i&&typeof i.onExit=="function"&&i.onExit(this,o),this.currentSceneName=t,this.currentScene=s,s&&typeof s.onEnter=="function"){const h=s.onEnter(this,o);h&&typeof h.catch=="function"&&h.catch(a=>{this.eventBus.emit("scene:error",{scene:t,error:a})})}return this.eventBus.emit("scene:switch",{from:n,to:t,fromScene:i,toScene:s,name:t,payload:e}),!0}start(){this.running||(this.running=!0,this.accumulator=0,this.lastTime=performance.now(),this.input.attach(),this.handleResize(),window.addEventListener("resize",this.handleResize),this.canvas.addEventListener("pointerdown",this.handlePointerDown,{passive:!1}),this.canvas.addEventListener("pointermove",this.handlePointerMove,{passive:!1}),this.canvas.addEventListener("pointerup",this.handlePointerUp,{passive:!1}),this.canvas.addEventListener("pointercancel",this.handlePointerCancel,{passive:!1}),this.canvas.addEventListener("pointerleave",this.handlePointerUp,{passive:!1}),this.rafId=window.requestAnimationFrame(this.loop),this.eventBus.emit("game:start"))}stop(){this.running&&(this.running=!1,this.input.detach(),window.removeEventListener("resize",this.handleResize),this.canvas.removeEventListener("pointerdown",this.handlePointerDown),this.canvas.removeEventListener("pointermove",this.handlePointerMove),this.canvas.removeEventListener("pointerup",this.handlePointerUp),this.canvas.removeEventListener("pointercancel",this.handlePointerCancel),this.canvas.removeEventListener("pointerleave",this.handlePointerUp),this.rafId!==null&&(window.cancelAnimationFrame(this.rafId),this.rafId=null),this.eventBus.emit("game:stop"))}handleResize(){this.dpr=window.devicePixelRatio||1,this.viewWidth=Math.max(1,window.innerWidth),this.viewHeight=Math.max(1,window.innerHeight),this.canvas.style.width=`${this.viewWidth}px`,this.canvas.style.height=`${this.viewHeight}px`,this.canvas.style.touchAction="none",this.canvas.width=Math.max(1,Math.round(this.viewWidth*this.dpr)),this.canvas.height=Math.max(1,Math.round(this.viewHeight*this.dpr)),this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0),this.camera.setViewport(this.viewWidth,this.viewHeight),this.currentScene&&typeof this.currentScene.onResize=="function"&&this.currentScene.onResize(this.viewWidth,this.viewHeight,this),this.eventBus.emit("game:resize",{width:this.viewWidth,height:this.viewHeight,dpr:this.dpr})}loop(t){if(!this.running)return;let e=t-this.lastTime;for(e>250&&(e=250),this.lastTime=t,this.accumulator+=e;this.accumulator>=this.fixedStepMs;){try{this.update(this.fixedStepMs/1e3)}catch(i){this.handleLoopError(i,"update");return}this.accumulator-=this.fixedStepMs}const s=this.accumulator/this.fixedStepMs;try{this.render(s)}catch(i){this.handleLoopError(i,"render");return}this.running&&(this.rafId=window.requestAnimationFrame(this.loop))}handleLoopError(t,e="unknown"){try{this.eventBus.emit("game:error",{phase:e,error:t,scene:this.currentSceneName,sceneObject:this.currentScene})}catch{}try{this.stop()}catch{this.running=!1,this.rafId!==null&&(window.cancelAnimationFrame(this.rafId),this.rafId=null)}}update(t){this.currentScene&&typeof this.currentScene.update=="function"&&this.currentScene.update(t,this),this.camera.update()}render(t){this.ctx.fillStyle=ri,this.ctx.fillRect(0,0,this.viewWidth,this.viewHeight),this.currentScene&&typeof this.currentScene.render=="function"&&this.currentScene.render(this.ctx,t,this)}handlePointerDown(t){this.routePointerEvent("handlePointerDown",t)}handlePointerMove(t){this.routePointerEvent("handlePointerMove",t)}handlePointerUp(t){this.routePointerEvent("handlePointerUp",t)}handlePointerCancel(t){this.routePointerEvent("handlePointerCancel",t)}routePointerEvent(t,e){if(!this.currentScene||typeof this.currentScene!="object")return;const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top,o={id:e.pointerId??0,x:i,y:n,button:e.button??0,buttons:e.buttons??0,pointerType:e.pointerType??"unknown",originalEvent:e},h=this.currentScene[t],a=t.replace("handle","on"),l=this.currentScene[a];let u=!1;typeof h=="function"?u=h.call(this.currentScene,o,this)===!0:typeof l=="function"&&(u=l.call(this.currentScene,o,this)===!0),u&&e.cancelable&&e.preventDefault()}}const di="bullet-dodge-arena:";function Ps(r){return`${di}${r}`}function Ms(r,t){var s;const e=typeof globalThis=="object"&&typeof((s=globalThis.console)==null?void 0:s.warn)=="function"?globalThis.console.warn.bind(globalThis.console):null;if(e){if(t instanceof Error){e(`${r} (${t.name}: ${t.message})`);return}e(r)}}function fi(r,t){const e=Ps(r);try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(s){return Ms(`[storage] Failed to save key "${e}".`,s),!1}}function pi(r,t=null){const e=Ps(r);try{const s=localStorage.getItem(e);return s===null?t:JSON.parse(s)}catch(s){return Ms(`[storage] Failed to load key "${e}".`,s),t}}const Bs="settings",mi=new Set(["touch","keyboard"]),G=Object.freeze({soundEnabled:!0,musicEnabled:!0,musicVolume:.7,sfxVolume:.8,controlScheme:"touch"});let ht={...G};function De(r){return r&&typeof r=="object"&&!Array.isArray(r)?r:{}}function yi(r,t,e){return Math.min(e,Math.max(t,r))}function We(r,t){if(typeof r=="boolean")return r;if(typeof r=="string"){const e=r.trim().toLowerCase();if(e==="true"||e==="1")return!0;if(e==="false"||e==="0")return!1}return typeof r=="number"&&Number.isFinite(r)?r!==0:t}function Oe(r,t){const e=Number(r);return Number.isFinite(e)?yi(e,0,1):t}function gi(r,t){if(typeof r!="string")return t;const e=r.trim().toLowerCase();return mi.has(e)?e:t}function Ts(r,t=G){const e=De(r),s=De(t);return{soundEnabled:We(e.soundEnabled,s.soundEnabled??G.soundEnabled),musicEnabled:We(e.musicEnabled,s.musicEnabled??G.musicEnabled),musicVolume:Oe(e.musicVolume,s.musicVolume??G.musicVolume),sfxVolume:Oe(e.sfxVolume,s.sfxVolume??G.sfxVolume),controlScheme:gi(e.controlScheme,s.controlScheme??G.controlScheme)}}function wi(r){fi(Bs,r)}function bt(){const r=pi(Bs,{});return ht=Ts(r,G),{...ht}}function me(r={}){return ht=Ts(r,ht),wi(ht),{...ht}}function m(r,t=0){const e=Number(r);return Number.isFinite(e)?e:t}function E(r,t,e){const s=Math.min(t,e),i=Math.max(t,e);return Math.min(Math.max(r,s),i)}function $(r,t,e){if(r&&typeof r=="object"){const o=m(r.x,m(r.clientX,m(r.pageX,NaN))),h=m(r.y,m(r.clientY,m(r.pageY,NaN))),a=m(r.pointerId,m(r.identifier,m(r.id,0)));return!Number.isFinite(o)||!Number.isFinite(h)?null:{x:o,y:h,id:a}}const s=m(r,NaN),i=m(t,NaN),n=m(e,0);return!Number.isFinite(s)||!Number.isFinite(i)?null:{x:s,y:i,id:n}}function J(r,t,e,s,i,n){const o=E(n,0,Math.min(s,i)*.5);r.beginPath(),r.moveTo(t+o,e),r.lineTo(t+s-o,e),r.quadraticCurveTo(t+s,e,t+s,e+o),r.lineTo(t+s,e+i-o),r.quadraticCurveTo(t+s,e+i,t+s-o,e+i),r.lineTo(t+o,e+i),r.quadraticCurveTo(t,e+i,t,e+i-o),r.lineTo(t,e+o),r.quadraticCurveTo(t,e,t+o,e),r.closePath()}function qt(r){const t=(r==null?void 0:r.canvas)??null;if(!t)return{width:0,height:0};const e=m(t.clientWidth,0),s=m(t.clientHeight,0);if(e>0&&s>0)return{width:e,height:s};const i=typeof r.getTransform=="function"?r.getTransform():null,n=i&&Number.isFinite(i.a)&&Math.abs(i.a)>0?Math.abs(i.a):1,o=i&&Number.isFinite(i.d)&&Math.abs(i.d)>0?Math.abs(i.d):1;return{width:m(t.width,0)/n,height:m(t.height,0)/o}}function N(r,t,e=0){if(!r||typeof r!="object")return e;for(const s of t){const i=Number(r[s]);if(Number.isFinite(i))return i}return e}function Ne(r){const t=Number.isFinite(r)?r:0;return typeof t.toLocaleString=="function"?t.toLocaleString("en-US"):String(t)}const He={radius:12,fill:"rgba(28, 38, 60, 0.82)",fillPressed:"rgba(62, 108, 196, 0.9)",fillDisabled:"rgba(60, 68, 82, 0.58)",stroke:"rgba(168, 188, 224, 0.85)",strokePressed:"rgba(220, 236, 255, 0.95)",text:"#f4f8ff",textDisabled:"#a5b2c4",font:"600 18px Arial",shadowColor:"rgba(0, 0, 0, 0.28)",shadowBlur:14};class ut{constructor(t={}){const e=t&&typeof t=="object"?t:{};this.x=m(e.x,0),this.y=m(e.y,0),this.width=Math.max(0,m(e.width,120)),this.height=Math.max(0,m(e.height,48)),this.label=typeof e.label=="string"?e.label:"",this.visible=e.visible!==!1,this.enabled=e.enabled!==!1,this.onClick=typeof e.onClick=="function"?e.onClick:null,this.style={...He,...e.style&&typeof e.style=="object"?e.style:{}},this._activePointerId=null,this._pressed=!1,this._pointerInside=!1}setBounds(t,e,s,i){this.x=m(t,this.x),this.y=m(e,this.y),this.width=Math.max(0,m(s,this.width)),this.height=Math.max(0,m(i,this.height))}setLabel(t){this.label=typeof t=="string"?t:""}setEnabled(t){this.enabled=t!==!1,this.enabled||this.reset()}setVisible(t){this.visible=t!==!1,this.visible||this.reset()}setOnClick(t){this.onClick=typeof t=="function"?t:null}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}isPressed(){return this._pressed}containsPoint(t,e){if(!this.visible||this.width<=0||this.height<=0)return!1;const s=m(t,NaN),i=m(e,NaN);return!Number.isFinite(s)||!Number.isFinite(i)?!1:s>=this.x&&s<=this.x+this.width&&i>=this.y&&i<=this.y+this.height}handlePointerDown(t,e,s){if(!this.enabled||!this.visible)return!1;const i=$(t,e,s);return!i||!this.containsPoint(i.x,i.y)?!1:(this._activePointerId=i.id,this._pressed=!0,this._pointerInside=!0,!0)}handlePointerMove(t,e,s){if(!this._pressed)return!1;const i=$(t,e,s);return!i||i.id!==this._activePointerId?!1:(this._pointerInside=this.containsPoint(i.x,i.y),!0)}handlePointerUp(t,e,s){if(!this._pressed)return!1;const i=$(t,e,s);if(!i||i.id!==this._activePointerId)return!1;const n=this.enabled&&this.visible&&this._pointerInside&&this.containsPoint(i.x,i.y);return this.reset(),n&&typeof this.onClick=="function"&&this.onClick(i,this),n}handlePointerCancel(t,e,s){if(!this._pressed)return!1;const i=$(t,e,s);return!i||i.id!==this._activePointerId?!1:(this.reset(),!0)}reset(){this._activePointerId=null,this._pressed=!1,this._pointerInside=!1}render(t){if(!t||typeof t.save!="function"||!this.visible||this.width<=0||this.height<=0)return;const e=this._pressed&&this.enabled,s=this.enabled?e?this.style.fillPressed:this.style.fill:this.style.fillDisabled,i=e?this.style.strokePressed:this.style.stroke,n=this.enabled?this.style.text:this.style.textDisabled;t.save(),t.shadowColor=this.style.shadowColor,t.shadowBlur=m(this.style.shadowBlur,0),J(t,this.x,this.y,this.width,this.height,m(this.style.radius,0)),t.fillStyle=s,t.fill(),t.shadowBlur=0,t.lineWidth=2,t.strokeStyle=i,t.stroke(),this.label.length>0&&(t.fillStyle=n,t.font=typeof this.style.font=="string"?this.style.font:He.font,t.textAlign="center",t.textBaseline="middle",t.fillText(this.label,this.x+this.width/2,this.y+this.height/2)),t.restore()}}const vi=()=>{var r,t;return!!((t=(r=import.meta)==null?void 0:r.env)!=null&&t.DEV)};function d(r,t=0){const e=Number(r);return Number.isFinite(e)?e:t}function g(r){return!!r&&typeof r=="object"}function F(r){if(!g(r))return null;const t=d(r.x,d(r.clientX,NaN)),e=d(r.y,d(r.clientY,NaN));return!Number.isFinite(t)||!Number.isFinite(e)?null:{x:t,y:e,id:r.id??r.pointerId??r.identifier??"primary"}}function V(r,t){return t.x>=r.x&&t.x<=r.x+r.width&&t.y>=r.y&&t.y<=r.y+r.height}function S(r,t,e,s="scene-call"){if(!g(r))return{called:!1,value:void 0};for(const i of t){if(typeof r[i]!="function")continue;let n=null;for(const o of e)try{return{called:!0,value:r[i](...o)}}catch(h){n=h}n&&vi()&&console.error(`[${s}] ${i} failed for all signatures`,n)}return{called:!1,value:void 0}}function Ee(r){return r==="handlePointerDown"?["handlePointerDown","pointerDown","onPointerDown"]:r==="handlePointerMove"?["handlePointerMove","pointerMove","onPointerMove"]:r==="handlePointerUp"?["handlePointerUp","pointerUp","onPointerUp"]:r==="handlePointerCancel"?["handlePointerCancel","pointerCancel","onPointerCancel"]:[r]}const Mt=ut;class bi{constructor(){this.width=1,this.height=1,this.playButton=null,this.soundButton=null,this.musicButton=null,this.buttons=[],this.activePointerId=null,this.activeButton=null,this.settings=bt()}onEnter(t,e){this.settings=bt(),this.playButton=this.createButton("Play",()=>{t.switchScene("versus",{restart:!0})}),this.soundButton=this.createButton("",()=>{var s,i,n,o;this.settings=me({soundEnabled:!this.settings.soundEnabled}),(i=(s=t.audioManager)==null?void 0:s.setEnabled)==null||i.call(s,this.settings.soundEnabled),this.syncSettingsButtons(),(o=(n=t.eventBus)==null?void 0:n.emit)==null||o.call(n,"ui_click",{source:"toggle_sound"})}),this.musicButton=this.createButton("",()=>{var s,i,n,o;this.settings=me({musicEnabled:!this.settings.musicEnabled}),(i=(s=t.musicManager)==null?void 0:s.setEnabled)==null||i.call(s,this.settings.musicEnabled),this.syncSettingsButtons(),(o=(n=t.eventBus)==null?void 0:n.emit)==null||o.call(n,"ui_click",{source:"toggle_music"})}),this.syncSettingsButtons(),this.buttons=[this.playButton,this.soundButton,this.musicButton],this.activePointerId=null,this.activeButton=null,this.onResize(d(t==null?void 0:t.viewWidth,this.width),d(t==null?void 0:t.viewHeight,this.height),t)}onExit(t,e){this.activePointerId=null,this.activeButton=null;for(const s of this.buttons)this.setPressed(s,!1)}onResize(t,e,s){this.width=Math.max(1,d(t,1)),this.height=Math.max(1,d(e,1));const i=Math.min(280,Math.max(180,this.width*.28)),n=Math.min(72,Math.max(54,this.height*.085)),o=(this.width-i)*.5,h=this.height*.58,a=Math.min(220,Math.max(150,this.width*.22)),l=Math.min(56,Math.max(44,this.height*.064)),u=h+n+Math.max(14,this.height*.025),c=Math.max(12,this.width*.02);if(this.setButtonRect(this.playButton,o,h,i,n),this.width>=560){const y=a*2+c,p=(this.width-y)*.5;this.setButtonRect(this.soundButton,p,u,a,l),this.setButtonRect(this.musicButton,p+a+c,u,a,l)}else{const y=(this.width-a)*.5;this.setButtonRect(this.soundButton,y,u,a,l),this.setButtonRect(this.musicButton,y,u+l+Math.max(10,this.height*.015),a,l)}}update(t,e){for(const s of this.buttons)S(s,["update"],[[t,e],[t],[]])}render(t,e,s){t.save();const i=t.createLinearGradient(0,0,0,this.height);i.addColorStop(0,"#17233b"),i.addColorStop(1,"#0a111f"),t.fillStyle=i,t.fillRect(0,0,this.width,this.height),t.fillStyle="#f5f7ff",t.textAlign="center",t.textBaseline="middle",t.font="700 56px Arial",t.fillText("BULLET DODGE ARENA",this.width*.5,this.height*.34),t.font="400 20px Arial",t.fillStyle="#b9c4e8",t.fillText("Phase 7",this.width*.5,this.height*.42);for(const n of this.buttons)this.renderButton(t,n);t.restore()}handlePointerDown(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerDown",s,e))return!0;const n=this.findButtonAt(s);return n?(this.activePointerId=s.id,this.activeButton=n,this.setPressed(n,!0),!0):!1}handlePointerMove(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerMove",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=V(this.getButtonRect(this.activeButton),s);return this.setPressed(this.activeButton,n),!0}handlePointerUp(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerUp",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=this.activeButton,o=V(this.getButtonRect(n),s);return this.setPressed(n,!1),this.activePointerId=null,this.activeButton=null,o&&this.pressButton(n,e),!0}handlePointerCancel(t,e){const s=F(t);return(s?this.routePointer("handlePointerCancel",s,e):!1)?!0:this.activeButton?(this.setPressed(this.activeButton,!1),this.activeButton=null,this.activePointerId=null,!0):!1}createButton(t,e){let s=null;const i={label:t,text:t,onPress:e,onTap:e,onClick:e,x:0,y:0,width:0,height:0};if(typeof Mt=="function"){const n=[()=>new Mt(i),()=>new Mt(t,0,0,0,0,e),()=>new Mt(0,0,0,0,t,e)];for(const o of n)try{s=o();break}catch{}}return g(s)||(s={}),s.__sceneButton={label:t,onPress:e,pressed:!1,rect:{x:0,y:0,width:0,height:0}},s}syncSettingsButtons(){const t=this.settings.soundEnabled?"SFX: ON":"SFX: OFF",e=this.settings.musicEnabled?"MUSIC: ON":"MUSIC: OFF";this.setButtonLabel(this.soundButton,t),this.setButtonLabel(this.musicButton,e)}setButtonLabel(t,e){g(t)&&(g(t.__sceneButton)&&(t.__sceneButton.label=e),"label"in t&&(t.label=e),"text"in t&&(t.text=e),S(t,["setLabel","setText"],[[e]]))}setButtonRect(t,e,s,i,n){if(!g(t))return;const o={x:d(e,0),y:d(s,0),width:Math.max(0,d(i,0)),height:Math.max(0,d(n,0))};S(t,["setBounds","setRect","setFrame"],[[o.x,o.y,o.width,o.height],[o]]),S(t,["setPosition"],[[o.x,o.y]]),S(t,["setSize","resize"],[[o.width,o.height]]),"x"in t&&(t.x=o.x),"y"in t&&(t.y=o.y),"width"in t&&(t.width=o.width),"height"in t&&(t.height=o.height),g(t.bounds)&&(t.bounds.x=o.x,t.bounds.y=o.y,t.bounds.width=o.width,t.bounds.height=o.height),g(t.__sceneButton)&&(t.__sceneButton.rect=o)}getButtonRect(t){return g(t)?g(t.bounds)?{x:d(t.bounds.x,0),y:d(t.bounds.y,0),width:Math.max(0,d(t.bounds.width,0)),height:Math.max(0,d(t.bounds.height,0))}:g(t.__sceneButton)&&g(t.__sceneButton.rect)?t.__sceneButton.rect:{x:d(t.x,0),y:d(t.y,0),width:Math.max(0,d(t.width,0)),height:Math.max(0,d(t.height,0))}:{x:0,y:0,width:0,height:0}}setPressed(t,e){g(t)&&(S(t,["setPressed","setDown","setActive"],[[e]]),"pressed"in t&&(t.pressed=e),g(t.__sceneButton)&&(t.__sceneButton.pressed=e))}findButtonAt(t){for(let e=this.buttons.length-1;e>=0;e-=1){const s=this.buttons[e];if(V(this.getButtonRect(s),t))return s}return null}pressButton(t,e){S(t,["press","trigger","click","onPress","onTap","onClick"],[[e],[]]).called||g(t.__sceneButton)&&typeof t.__sceneButton.onPress=="function"&&t.__sceneButton.onPress(e)}renderButton(t,e){if(S(e,["render","draw"],[[t,this],[t]]).called)return;const i=this.getButtonRect(e),n=g(e.__sceneButton)?e.__sceneButton:null,o=!!(n!=null&&n.pressed);t.save(),t.fillStyle=o?"#2f65d4":"#3d7ef2",t.strokeStyle="#dbe6ff",t.lineWidth=2,t.fillRect(i.x,i.y,i.width,i.height),t.strokeRect(i.x,i.y,i.width,i.height),t.fillStyle="#ffffff",t.textAlign="center",t.textBaseline="middle",t.font="700 26px Arial",t.fillText((n==null?void 0:n.label)??"Button",i.x+i.width*.5,i.y+i.height*.5),t.restore()}routePointer(t,e,s){const i=Ee(t);for(let n=this.buttons.length-1;n>=0;n-=1){const o=this.buttons[n],h=S(o,i,[[e,s],[e],[e.x,e.y,e.id]]);if(h.called&&h.value)return!0}return!1}}class Qt{constructor({x:t=0,y:e=0,vx:s=0,vy:i=0,width:n=1,height:o=1,active:h=!0}={}){this.x=t,this.y=e,this.vx=s,this.vy=i,this.width=Math.max(0,Number(n)||0),this.height=Math.max(0,Number(o)||0),this.active=h}update(t,e){}render(t,e){}projectToScreen(t,e=this.x,s=this.y){let i=Number(e),n=Number(s);if(t&&typeof t.worldToScreen=="function"){const o=t.worldToScreen(i,n);i=Number(o==null?void 0:o.x),n=Number(o==null?void 0:o.y)}else if(t&&typeof t=="object"){const o=Number(t.x),h=Number(t.y);i-=Number.isFinite(o)?o:0,n-=Number.isFinite(h)?h:0}return!Number.isFinite(i)||!Number.isFinite(n)?null:{x:i,y:n}}getBounds(){return{x:this.x,y:this.y,width:this.width,height:this.height}}setPosition(t,e){this.x=t,this.y=e}setVelocity(t,e){this.vx=t,this.vy=e}activate(t=this.x,e=this.y){this.x=t,this.y=e,this.active=!0}deactivate(){this.active=!1}}function C(r,t,e){const s=Math.min(t,e),i=Math.max(t,e);return Math.min(Math.max(r,s),i)}const Si=1e-4,j=(r,t)=>{const e=Number(r);return Number.isFinite(e)?e:t};class yt extends Qt{constructor({x:t=0,y:e=0,vx:s=0,vy:i=0,width:n=28,height:o=40,active:h=!0,maxHealth:a=100,health:l=a,onGround:u=!1,facing:c=1,animationState:y="idle",shootCooldownMs:p=220,lastShotAtMs:w=Number.NEGATIVE_INFINITY,color:P=fe,markerColor:R=pe}={}){super({x:t,y:e,vx:s,vy:i,width:n,height:o,active:h}),this.maxHealth=Math.max(1,j(a,100)),this.health=C(j(l,this.maxHealth),0,this.maxHealth),this.onGround=!!u,this.facing=j(c,1)<0?-1:1,this.animationState=typeof y=="string"?y:"idle",this.shootCooldownMs=Math.max(0,j(p,220)),this.lastShotAtMs=j(w,Number.NEGATIVE_INFINITY),this.color=typeof P=="string"&&P.length>0?P:fe,this.markerColor=typeof R=="string"&&R.length>0?R:pe,this.moveIntent=0,this.jumpRequested=!1}applyInput(t,e){const s=t&&typeof t=="object",i=s&&typeof t.isPressed=="function"?t.isPressed.bind(t):()=>!1,n=s&&typeof t.consumePressed=="function"?t.consumePressed.bind(t):()=>!1,o=!!i("left"),a=(!!i("right")?1:0)-(o?1:0);this.moveIntent=C(a,-1,1),this.moveIntent!==0&&this.active&&(this.facing=this.moveIntent<0?-1:1),this.jumpRequested=!!n("jump")||this.jumpRequested}canShoot(t=performance.now()){return j(t,0)-this.lastShotAtMs>=this.shootCooldownMs}markShot(t=performance.now()){this.lastShotAtMs=j(t,0)}takeDamage(t){const e=Math.max(0,j(t,0));return e<=0||this.health<=0?this.health:(this.health=Math.max(0,this.health-e),this.health<=0&&(this.active=!1),this.health)}heal(t){const e=Math.max(0,j(t,0));return e<=0||this.health>=this.maxHealth?this.health:(this.health=Math.min(this.maxHealth,this.health+e),this.health)}update(t,e){this.active&&(this.onGround?Math.abs(this.vx)>Si?this.animationState="run":this.animationState="idle":this.animationState=this.vy<0?"jump":"fall")}render(t,e){if(!this.active||!t)return;const s=this.projectToScreen(e);if(!s)return;const i=s.x,n=s.y;t.fillStyle=this.color,t.fillRect(i,n,this.width,this.height);const o=Math.max(3,this.width*.28),h=Math.max(2,this.height*.12),a=this.facing>=0?i+this.width-o:i,l=n+(this.height-h)*.5;t.fillStyle=this.markerColor,t.fillRect(a,l,o,h)}}const b=Object.freeze({GRUNT:"GRUNT",SNIPER:"SNIPER",RUSHER:"RUSHER",TANK:"TANK",BOSS:"BOSS"}),Ye=Object.freeze({[b.GRUNT]:{hp:40,speed:120,damage:8,fireCooldownMs:900,color:dt.GRUNT,width:24,height:24},[b.SNIPER]:{hp:30,speed:80,damage:14,fireCooldownMs:1500,color:dt.SNIPER,width:24,height:24},[b.RUSHER]:{hp:28,speed:180,damage:6,fireCooldownMs:700,color:dt.RUSHER,width:22,height:22},[b.TANK]:{hp:90,speed:60,damage:16,fireCooldownMs:1400,color:dt.TANK,width:30,height:30},[b.BOSS]:{hp:300,speed:75,damage:24,fireCooldownMs:1e3,color:dt.BOSS,width:44,height:44}}),je=r=>{const t=Object.prototype.hasOwnProperty.call(Ye,r)?r:b.GRUNT;return{resolvedType:t,defaults:Ye[t]}},Ue=(r={})=>{const t=Number(r==null?void 0:r.x),e=Number(r==null?void 0:r.y);return{x:Number.isFinite(t)?t:0,y:Number.isFinite(e)?e:0}};class Is extends Qt{constructor(t=b.GRUNT,e={}){const{defaults:s}=je(t),{x:i,y:n}=Ue(e);super({x:i,y:n,width:s.width,height:s.height,vx:0,vy:0,active:!1}),this.type=b.GRUNT,this.maxHealth=1,this.health=1,this.speed=0,this.damage=0,this.fireCooldownMs=1e3,this.lastShotAtMs=-1/0,this.state="idle",this.color="#ffffff",this.moveIntent=0,this.configure(t,e)}configure(t=this.type,e={}){const{resolvedType:s,defaults:i}=je(t),{x:n,y:o}=Ue(e);return this.type=s,this.maxHealth=i.hp,this.health=i.hp,this.speed=i.speed,this.damage=i.damage,this.fireCooldownMs=i.fireCooldownMs,this.lastShotAtMs=-1/0,this.state="idle",this.color=i.color,this.width=i.width,this.height=i.height,this.x=n,this.y=o,this.vx=0,this.vy=0,this.moveIntent=0,this.active=!0,this}decideAction(t){return{moveX:0}}canShoot(t){const e=Number(t);return Number.isFinite(e)?e-this.lastShotAtMs>=this.fireCooldownMs:!1}markShot(t){const e=Number(t);Number.isFinite(e)&&(this.lastShotAtMs=e)}takeDamage(t){if(!this.active)return this.health;const e=Number(t),s=Number.isFinite(e)?Math.max(0,e):0;return this.health=Math.max(0,this.health-s),this.health<=0&&(this.deactivate(),this.state="dead",this.vx=0,this.vy=0),this.health}update(t,e){if(!this.active)return;if(Math.abs(this.vy)>Number.EPSILON){this.state=this.vy<0?"jumping":"falling";return}const s=Math.abs(this.vx)>Number.EPSILON;this.state=s?"moving":"idle"}render(t,e){if(!this.active||!t)return;const s=this.projectToScreen(e);if(!s)return;const i=s.x,n=s.y;t.fillStyle=this.color,t.fillRect(i,n,this.width,this.height);const o=this.maxHealth>0?this.health/this.maxHealth:0,h=Math.max(0,Math.min(1,o)),a=3,l=n-(a+2);t.fillStyle="#2a2a2a",t.fillRect(i,l,this.width,a),t.fillStyle="#58d45d",t.fillRect(i,l,this.width*h,a)}}const Bt="#ffd54a",Tt=1e3;class jt extends Qt{constructor({width:t=6,height:e=6}={}){super({width:t,height:e,active:!1}),this.speed=0,this.directionX=1,this.directionY=0,this.damage=0,this.owner=null,this.previousX=0,this.previousY=0,this.dodgeCounted=!1,this.lifetimeMs=Tt,this.ageMs=0,this.color=Bt}fire({x:t=this.x,y:e=this.y,directionX:s=1,directionY:i=0,speed:n=0,damage:o=0,owner:h=null,lifetimeMs:a=Tt,color:l=Bt,shape:u="rect"}={}){const c=Number(s),y=Number(i);let p=Number.isFinite(c)?c:0,w=Number.isFinite(y)?y:0;const P=Math.hypot(p,w);P<=Number.EPSILON?(p=1,w=0):(p/=P,w/=P),this.x=Number.isFinite(Number(t))?Number(t):0,this.y=Number.isFinite(Number(e))?Number(e):0,this.previousX=this.x,this.previousY=this.y,this.directionX=p,this.directionY=w;const R=Number(n);this.speed=Number.isFinite(R)?Math.max(0,R):0;const q=Number(o);this.damage=Number.isFinite(q)?q:0,this.owner=h??null;const Y=Number(a);this.lifetimeMs=Number.isFinite(Y)&&Y>0?Y:Tt,this.ageMs=0,this.dodgeCounted=!1,this.color=typeof l=="string"&&l.length>0?l:Bt,this.shape=u==="circle"?"circle":"rect",this.setVelocity(this.directionX*this.speed,this.directionY*this.speed),this.active=!0}update(t,e){if(!this.active)return;const s=Number(t),i=Number.isFinite(s)&&s>0?s:0;this.previousX=this.x,this.previousY=this.y,this.x+=this.vx*i,this.y+=this.vy*i,this.ageMs+=i*1e3,this.ageMs>=this.lifetimeMs&&(this.deactivate(),this.vx=0,this.vy=0)}reset(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.speed=0,this.directionX=1,this.directionY=0,this.damage=0,this.owner=null,this.previousX=0,this.previousY=0,this.dodgeCounted=!1,this.lifetimeMs=Tt,this.ageMs=0,this.color=Bt,this.shape="rect",this.deactivate()}render(t,e){if(!this.active||!t)return;const s=this.projectToScreen(e);if(!s)return;const i=s.x,n=s.y;if(t.fillStyle=this.color,this.shape==="circle"&&typeof t.beginPath=="function"&&typeof t.arc=="function"){const o=Math.max(1,Math.min(this.width,this.height)/2),h=i+this.width/2,a=n+this.height/2;t.beginPath(),t.arc(h,a,o,0,Math.PI*2),t.fill();return}t.fillRect(i,n,this.width,this.height)}}class Ut extends Qt{constructor(t,e,s,i,n="#2f7d1f"){super({x:t,y:e,width:s,height:i,vx:0,vy:0}),this.color=n}update(t,e){this.vx=0,this.vy=0}render(t,e){const i=typeof(e==null?void 0:e.worldToScreen)=="function"?e.worldToScreen(this.x,this.y):{x:this.x,y:this.y};t.fillStyle=this.color,t.fillRect(i.x,i.y,this.width,this.height)}}function M(r){return Number.isFinite(Number(r))}function T(r,t=0){const e=Number(r);return Number.isFinite(e)?e:t}function Xt(r){return Array.isArray(r)?r:r?[r]:[]}function X(r){return!!r&&r.active!==!1}function k(r,t,e){!r||typeof r.emit!="function"||r.emit(t,e)}function _i(r){const t=Number(r);return Number.isFinite(t)?t:typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}const Pi=260,Mi=Object.freeze({[b.GRUNT]:240,[b.RUSHER]:200,[b.TANK]:280,[b.BOSS]:360,[b.SNIPER]:520}),Xe=.001,Ve=r=>T(r==null?void 0:r.x,0)+T(r==null?void 0:r.width,0)*.5,Bi=r=>{const t=Mi[r==null?void 0:r.type];return Number.isFinite(t)?t:Pi},Ti=(r,t)=>{if(!r||t.length===0)return null;const e=Ve(r);let s=null;for(const i of t){if(!X(i))continue;const n=Ve(i)-e,o=Math.abs(n);(!s||o<s.distanceX)&&(s={player:i,dx:n,distanceX:o})}return s};class Ii{update(t,e={}){const s=Xt(e.enemies),i=Xt(e.players).filter(X),n=e.eventBus,o=_i(e.nowMs);for(const h of s){if(!X(h))continue;const a=Ti(h,i),l=(a==null?void 0:a.player)??null;let u=0;a&&h.type!==b.SNIPER&&(a.dx>Xe?u=1:a.dx<-Xe&&(u=-1)),h.moveIntent=u,k(n,"enemy_move_intent",{enemy:h,moveIntent:u,target:l}),a&&(typeof h.canShoot!="function"||typeof h.markShot!="function"||!h.canShoot(o)||a.distanceX>Bi(h)||(h.markShot(o),k(n,"enemy_shoot",{enemy:h})))}}}class D{static applyGravity(t,e,s){return t+e*s}static integrate(t,e,s){return t+e*s}static applyFriction(t,e,s){const i=Math.max(0,Math.abs(t)-e*s);return Math.sign(t)*i}static aabbOverlap(t,e){return t.x<=e.x+e.width&&t.x+t.width>=e.x&&t.y<=e.y+e.height&&t.y+t.height>=e.y}static clamp(t,e,s){return C(t,e,s)}}const ze=r=>C(T(r,0),-1,1);class As{update(t,e={}){const s=T(t,0);if(s<=0)return;const i=Xt(e.players),n=Xt(e.enemies);e.platforms,e.bullets;for(const o of i){if(!o||o.active===!1)continue;const h=ze(o.moveIntent);if(Math.abs(h)>0){const a=T(o.vx,0)+h*hi*s;o.vx=C(a,-Le,Le)}else o.vx=D.applyFriction(T(o.vx,0),ai,s);o.moveIntent=0,o.jumpRequested&&o.onGround&&(o.vy=-560,o.onGround=!1),o.jumpRequested=!1,o.onGround||(o.vy=D.applyGravity(T(o.vy,0),Fe,s)),o.x=D.integrate(T(o.x,0),T(o.vx,0),s),o.y=D.integrate(T(o.y,0),T(o.vy,0),s)}for(const o of n)if(!(!o||o.active===!1)){if(o.moveIntent!==void 0){const h=ze(o.moveIntent),a=Math.max(0,T(o.speed,0));o.vx=h*a,o.moveIntent=0}o.vy=D.applyGravity(T(o.vy,0),Fe,s),o.x=D.integrate(T(o.x,0),T(o.vx,0),s),o.y=D.integrate(T(o.y,0),T(o.vy,0),s)}}}const Ai=r=>r&&typeof r=="object"&&M(r.x)&&M(r.y)&&M(r.width)&&M(r.height)&&Number(r.width)>=0&&Number(r.height)>=0,tt=r=>Ai(r)&&r.active!==!1,Ni=r=>{!r||typeof r!="object"||(typeof r.deactivate=="function"?r.deactivate():r.active=!1,M(r.vx)&&(r.vx=0),M(r.vy)&&(r.vy=0))},Ke=r=>({x:Number(r.x)+Number(r.width)*.5,y:Number(r.y)+Number(r.height)*.5}),Ei=(r,t)=>{const e=Number(r.x)+Number(r.width)/2,s=Number(r.y)+Number(r.height)/2,i=Number(t.x)+Number(t.width)/2,n=Number(t.y)+Number(t.height)/2,o=Number(r.width)/2+Number(t.width)/2,h=Number(r.height)/2+Number(t.height)/2,a=e-i,l=s-n;return{deltaX:a,deltaY:l,overlapX:o-Math.abs(a),overlapY:h-Math.abs(l)}},Ri=(r,t)=>{const e=r==null?void 0:r.owner;return typeof e=="string"?e.toLowerCase()==="player":!e||typeof e!="object"?!1:e.isPlayer===!0||typeof e.type=="string"&&e.type.toLowerCase()==="player"?!0:t.includes(e)};var x,ye,Ns,gt,Es;class xi{constructor(){L(this,x);this._activePlayers=[],this._activeEnemies=[],this._activePlatforms=[],this._activeBullets=[]}update(t,e={}){const s=f(this,x,gt).call(this,e==null?void 0:e.players,this._activePlayers),i=f(this,x,gt).call(this,e==null?void 0:e.enemies,this._activeEnemies),n=f(this,x,gt).call(this,e==null?void 0:e.bullets,this._activeBullets),o=f(this,x,gt).call(this,e==null?void 0:e.platforms,this._activePlatforms),h=e==null?void 0:e.eventBus;f(this,x,ye).call(this,s,o),f(this,x,ye).call(this,i,o),f(this,x,Ns).call(this,n,s,i,h)}}x=new WeakSet,ye=function(t,e){for(const s of t){if(!tt(s))continue;let i=!1;for(const n of e){if(!D.aabbOverlap(s,n))continue;const{deltaX:o,deltaY:h,overlapX:a,overlapY:l}=Ei(s,n);if(!(!(a>0)||!(l>0))){if(a<l){s.x+=o<0?-a:a,M(s.vx)&&(s.vx=0);continue}s.y+=h<0?-l:l,M(s.vy)&&(s.vy=0),h<0&&(i=!0)}}s.onGround=i}},Ns=function(t,e,s,i){for(const n of t){if(!tt(n))continue;const o=Ri(n,e),h=o?s:e;let a=!1;for(const l of h){if(!tt(l)||!D.aabbOverlap(n,l))continue;const u=M(n.damage)?Math.max(0,Number(n.damage)):0,c=M(l.health)?Number(l.health):null,y=l.active!==!1;if(typeof l.takeDamage=="function"&&l.takeDamage(u),Ni(n),k(i,"bullet_hit",{bullet:n,target:l,damage:u}),o){const p=M(l.health)?Number(l.health):null,w=l.active===!1||c!==null&&p!==null&&c>0&&p<=0;y&&w&&k(i,"enemy_killed",{enemy:l,bullet:n})}else{const p=M(l.health)?Number(l.health):null,w=l.active===!1||c!==null&&p!==null&&c>0&&p<=0;k(i,"player_hit",{player:l,bullet:n,damage:u,isFatal:w,death:w,dead:w})}a=!0;break}!o&&!a&&f(this,x,Es).call(this,n,e,i)}},gt=function(t,e){if(e.length=0,!Array.isArray(t))return e;for(const s of t)tt(s)&&e.push(s);return e},Es=function(t,e,s){if(!tt(t)||t.dodgeCounted===!0||e.length===0)return;const i=e[0];if(!tt(i))return;const n=M(t.previousX)?Number(t.previousX):Number(t.x),o=Number(t.x),h=Ke(i),a=Ke(t);if(!(n<=h.x&&o>=h.x||n>=h.x&&o<=h.x))return;const u=Number(i.height)*.65+Number(t.height)*1.5;Math.abs(a.y-h.y)>u||(t.dodgeCounted=!0,k(s,"bullet_dodged",{bullet:t,player:i}))};const Zt=Object.freeze([{x:-64,y:0},{x:140,y:-32},{x:620,y:-32},{x:940,y:0}]),ki=new Set(Object.values(b)),Ci=Object.freeze({[b.GRUNT]:1,[b.RUSHER]:.85,[b.SNIPER]:1.25,[b.TANK]:1.6,[b.BOSS]:2.25}),Fi=(r,t=1)=>{const e=Number(r);return!Number.isFinite(e)||e<=0?t:Math.floor(e)},Ge=(r,t=0)=>{const e=Number(r);return Number.isFinite(e)?Math.max(0,e):t},Li=r=>ki.has(r)?r:b.GRUNT,Di=(r,t=[])=>Array.isArray(r)&&r.length>0?r:t,Wi=(r,t)=>{const e=Di(r,Zt),s=Zt[t%Zt.length],i=e[t%e.length]??s,n=Array.isArray(i)?Number(i[0]):Number(i==null?void 0:i.x),o=Array.isArray(i)?Number(i[1]):Number(i==null?void 0:i.y);return{x:Number.isFinite(n)?n:s.x,y:Number.isFinite(o)?o:s.y}},Oi=r=>{if(!Array.isArray(r))return 0;let t=0;for(const e of r)e&&e.active!==!1&&(t+=1);return t},Hi=r=>{const t=Fi(r,1),e=Math.max(260,920-t*45),s=[],i=(n,o)=>{const h=Math.max(0,Math.floor(o));for(let a=0;a<h;a+=1){const l=Ci[n]??1;s.push({type:n,delayMs:Math.max(140,Math.round(e*l))})}};return i(b.GRUNT,3+t*2),t>=2&&i(b.RUSHER,1+Math.floor(t/2)),t>=3&&i(b.SNIPER,1+Math.floor((t-1)/2)),t>=4&&i(b.TANK,Math.floor((t-2)/2)),t%5===0&&i(b.BOSS,1),{wave:t,spawnIntervalMs:e,entries:s}};var ct,Rs,xs;class $e{constructor(t={}){L(this,ct);this.currentWave=0,this.waveActive=!1,this.pendingSpawns=[],this.spawnTimerMs=0,this.spawnedThisWave=0,this._waveSpawnIntervalMs=750,this._waveStartEventPending=!1,this.enemyPool=t.enemyPool??null,this.enemyFactory=typeof t.enemyFactory=="function"?t.enemyFactory:null}startWave(t=this.currentWave+1){const e=Hi(t);return this.currentWave=e.wave,this.waveActive=!0,this.pendingSpawns=e.entries.slice(),this.spawnTimerMs=0,this.spawnedThisWave=0,this._waveSpawnIntervalMs=e.spawnIntervalMs,this._waveStartEventPending=!0,this.getWaveInfo()}getWaveInfo(){return{currentWave:this.currentWave,waveActive:this.waveActive,pendingSpawns:this.pendingSpawns.length,spawnTimerMs:this.spawnTimerMs,spawnedThisWave:this.spawnedThisWave}}isWaveCleared(t={}){if(!this.waveActive)return!1;const e=Oi(t.enemies);return this.pendingSpawns.length===0&&e===0}update(t,e={}){const s=e==null?void 0:e.eventBus,i=(e==null?void 0:e.autoStart)===!0,n=Ge(t,0)*1e3,o=(e==null?void 0:e.enemyPool)??this.enemyPool;if(!this.waveActive&&i&&this.startWave(this.currentWave+1),!this.waveActive)return;Array.isArray(e.enemies)||(e.enemies=[]),f(this,ct,xs).call(this,e.enemies,o),this._waveStartEventPending&&(k(s,"wave_start",{wave:this.currentWave,totalEnemies:this.pendingSpawns.length}),this._waveStartEventPending=!1),this.spawnTimerMs-=n;let h=0;for(;this.pendingSpawns.length>0&&this.spawnTimerMs<=0&&h<200;){const a=this.pendingSpawns.shift(),l=Li((a==null?void 0:a.type)??a),u=Wi(e.spawnPoints,this.spawnedThisWave),c=f(this,ct,Rs).call(this,l,u,o);e.enemies.push(c),this.spawnedThisWave+=1,k(s,"enemy_spawned",{wave:this.currentWave,enemy:c,type:l,x:u.x,y:u.y});const y=Ge(a==null?void 0:a.delayMs,this._waveSpawnIntervalMs);this.spawnTimerMs+=Math.max(80,y),h+=1}this.isWaveCleared(e)&&(this.waveActive=!1,this.spawnTimerMs=0,k(s,"wave_cleared",{wave:this.currentWave,spawned:this.spawnedThisWave}))}}ct=new WeakSet,Rs=function(t,e,s){let i=null;return s&&typeof s.acquire=="function"&&(i=s.acquire()),!i&&this.enemyFactory&&(i=this.enemyFactory(t,e)),i?typeof i.configure=="function"&&i.configure(t,e):i=new Is(t,e),i},xs=function(t,e){let s=0;for(let i=0;i<t.length;i+=1){const n=t[i];if(n&&n.active!==!1){t[s]=n,s+=1;continue}e&&typeof e.release=="function"&&n&&e.release(n)}t.length=s};class Yi{constructor(t){this.eventBus=t,this._unsubscribeFns=[],this._initialState={score:0,kills:0,dodges:0,wave:0,deaths:0,hits:0},this.state={...this._initialState},!(!this.eventBus||typeof this.eventBus.on!="function")&&(this._unsubscribeFns.push(this.eventBus.on("enemy_killed",e=>{this.state.kills+=1,this.state.score+=this._resolvePoints(100,e)})),this._unsubscribeFns.push(this.eventBus.on("bullet_dodged",e=>{this.state.dodges+=1,this.state.score+=this._resolvePoints(10,e)})),this._unsubscribeFns.push(this.eventBus.on("wave_start",e=>{this.state.wave=this._resolveWave(e,this.state.wave)})),this._unsubscribeFns.push(this.eventBus.on("wave_cleared",e=>{this.state.wave=this._resolveWave(e,this.state.wave),this.state.score+=this._resolvePoints(500,e)})),this._unsubscribeFns.push(this.eventBus.on("player_hit",e=>{this.state.hits+=1,this.state.deaths+=this._resolveDeaths(e)})))}_resolvePoints(t,e){return!e||typeof e!="object"?t:typeof e.points=="number"?e.points:typeof e.extraPoints=="number"?t+e.extraPoints:t}_resolveDeaths(t){return!t||typeof t!="object"?0:typeof t.deaths=="number"?t.deaths:t.death===!0||t.isFatal===!0||t.dead===!0?1:0}_resolveWave(t,e=0){if(!t||typeof t!="object")return Math.max(0,Math.round(e));const s=[t.wave,t.currentWave,t.waveNumber];for(const i of s)if(typeof i=="number"&&Number.isFinite(i))return Math.max(0,Math.round(i));return Math.max(0,Math.round(e))}getState(){return{...this.state}}reset(){this.state={...this._initialState}}update(t){}dispose(){for(const t of this._unsubscribeFns)typeof t=="function"&&t();this._unsubscribeFns=[]}}const qe="#000",Qe=32;var v,ks,Cs,Fs,Ls,Ht,Yt,ge,A,wt,Ds;class ji{constructor(t=[],e=qe,s=Qe){L(this,v);this.fallbackColor=typeof e=="string"?e:qe,this.layers=[],this._imageCache=new Map,this._maxImageCacheEntries=f(this,v,Ds).call(this,s),this.setLayers(t)}setLayers(t=[]){const e=Array.isArray(t)?t:[];this.layers=e.map(s=>f(this,v,ks).call(this,s))}render(t,e,s,i){var l,u;if(!t||typeof t.fillRect!="function"||typeof t.drawImage!="function")return;const n=f(this,v,ge).call(this,s,(l=t.canvas)==null?void 0:l.width),o=f(this,v,ge).call(this,i,(u=t.canvas)==null?void 0:u.height),h=f(this,v,A).call(this,e==null?void 0:e.x,0),a=f(this,v,A).call(this,e==null?void 0:e.y,0);t.save(),t.fillStyle=this.fallbackColor,t.fillRect(0,0,n,o),t.restore();for(const c of this.layers){if(!c||!c.image||(c.ready||(c.ready=f(this,v,Ht).call(this,c.image),c.error=!c.ready&&f(this,v,Yt).call(this,c.image)),c.error||!c.ready))continue;const y=f(this,v,A).call(this,c.image.naturalWidth??c.image.width,0),p=f(this,v,A).call(this,c.image.naturalHeight??c.image.height,0);if(y<=0||p<=0)continue;const w=c.height>0?c.height:p,P=y*w/p;if(!Number.isFinite(P)||P<=0||w<=0)continue;const R=-h*c.parallaxX,q=c.y-a*c.parallaxY;if(t.save(),t.globalAlpha*=c.opacity,c.repeatX){const Y=(R%P+P)%P;for(let Jt=Y-P;Jt<n;Jt+=P)t.drawImage(c.image,Jt,q,P,w)}else t.drawImage(c.image,R,q,P,w);t.restore()}}}v=new WeakSet,ks=function(t){const e=t&&typeof t=="object"?t:{},s=typeof e.imageSrc=="string"?e.imageSrc.trim():"",i=f(this,v,wt).call(this,f(this,v,A).call(this,e.parallax,1),0,1),n=Object.prototype.hasOwnProperty.call(e,"parallaxY"),o={image:null,imageSrc:s,parallaxX:f(this,v,wt).call(this,f(this,v,A).call(this,e.parallaxX,i),0,1),parallaxY:f(this,v,wt).call(this,f(this,v,A).call(this,e.parallaxY,n?i:0),0,1),y:f(this,v,A).call(this,e.y,0),height:f(this,v,A).call(this,e.height,0),opacity:f(this,v,wt).call(this,f(this,v,A).call(this,e.opacity,1),0,1),repeatX:e.repeatX!==!1,ready:!1,error:!1},h=e.image??e.imageElement;if(f(this,v,Ls).call(this,h))return o.image=h,o.ready=f(this,v,Ht).call(this,h),o.error=!o.ready&&f(this,v,Yt).call(this,h),o;if(o.imageSrc&&typeof Image<"u"){const a=f(this,v,Cs).call(this,o.imageSrc);return a.decoding="async",o.image=a,o.ready=f(this,v,Ht).call(this,a),o.error=!o.ready&&f(this,v,Yt).call(this,a),o}return o.imageSrc&&(o.error=!0),o},Cs=function(t){if(this._imageCache.has(t)){const s=this._imageCache.get(t);return this._imageCache.delete(t),this._imageCache.set(t,s),s}const e=new Image;return e.decoding="async",e.src=t,this._imageCache.set(t,e),f(this,v,Fs).call(this),e},Fs=function(){for(;this._imageCache.size>this._maxImageCacheEntries;){const t=this._imageCache.keys().next().value;if(typeof t>"u")break;this._imageCache.delete(t)}},Ls=function(t){return!!(t&&typeof t=="object"&&("complete"in t||"naturalWidth"in t||"width"in t))},Ht=function(t){if(!!!(t!=null&&t.complete))return!1;const s=f(this,v,A).call(this,t.naturalWidth??t.width,0),i=f(this,v,A).call(this,t.naturalHeight??t.height,0);return s>0&&i>0},Yt=function(t){if(!(t!=null&&t.complete))return!1;const e=f(this,v,A).call(this,t.naturalWidth??t.width,0),s=f(this,v,A).call(this,t.naturalHeight??t.height,0);return e<=0||s<=0},ge=function(t,e){const s=f(this,v,A).call(this,t,e);return s>0?s:0},A=function(t,e){const s=Number(t);if(Number.isFinite(s))return s;const i=Number(e);return Number.isFinite(i)?i:0},wt=function(t,e,s){return Math.min(s,Math.max(e,t))},Ds=function(t){const e=Number(t);return Number.isFinite(e)?Math.max(1,Math.floor(e)):Qe};const Je=200,Ui=.02,Xi=Math.PI*2;function W(r,t){const e=Number(r);return Number.isFinite(e)?e:t}function It(r,t){const e=Number(r);return Number.isFinite(e)&&e>0?e:t}var $t,Ws;class Vi{constructor(t=Je){L(this,$t);const e=Math.floor(It(t,Je));this.capacity=e,this.particles=new Array(e),this.activeIndices=new Int32Array(e),this.activeLookup=new Int32Array(e),this.freeIndices=new Int32Array(e),this.activeCount=0,this.freeTop=e-1,this.alphaCutoff=Ui,this._projectionPoint={x:0,y:0};for(let s=0;s<e;s+=1)this.particles[s]={position:{x:0,y:0},velocity:{x:0,y:0},life:0,maxLife:0,size:1,color:"#ffffff",shape:"square",active:!1},this.activeLookup[s]=-1,this.freeIndices[s]=e-1-s}emit(t={}){if(this.freeTop<0)return!1;const e=this.freeIndices[this.freeTop];this.freeTop-=1;const s=this.particles[e],i=t.position,n=t.velocity;return s.position.x=W(t.x??(i==null?void 0:i.x),0),s.position.y=W(t.y??(i==null?void 0:i.y),0),s.velocity.x=W(t.vx??(n==null?void 0:n.x),0),s.velocity.y=W(t.vy??(n==null?void 0:n.y),0),s.maxLife=It(t.maxLife??t.life,1),s.life=s.maxLife,s.size=It(t.size,2),s.color=typeof t.color=="string"?t.color:"#ffffff",s.shape=t.shape==="circle"?"circle":"square",s.active=!0,this.activeIndices[this.activeCount]=e,this.activeLookup[e]=this.activeCount,this.activeCount+=1,!0}burst(t,e={}){const s=Math.max(0,Math.floor(W(t,0)));let i=0;for(let n=0;n<s&&this.emit(e);n+=1)i+=1;return i}update(t){const e=W(t,0);if(e<=0||this.activeCount===0)return;let s=0;for(;s<this.activeCount;){const i=this.activeIndices[s],n=this.particles[i];if(n.life-=e,n.life<=0){f(this,$t,Ws).call(this,s);continue}n.position.x+=n.velocity.x*e,n.position.y+=n.velocity.y*e,s+=1}}render(t,e){if(!t||this.activeCount===0)return;const s=W(e==null?void 0:e.x,0),i=W(e==null?void 0:e.y,0),n=typeof(e==null?void 0:e.worldToScreen)=="function",o=t.globalAlpha,h=t.fillStyle;for(let a=0;a<this.activeCount;a+=1){const l=this.particles[this.activeIndices[a]],u=l.maxLife>0?l.life/l.maxLife:0;if(u<=this.alphaCutoff)continue;const c=n?e.worldToScreen(l.position.x,l.position.y,this._projectionPoint):null,y=W(c==null?void 0:c.x,l.position.x-s),p=W(c==null?void 0:c.y,l.position.y-i),w=It(l.size,1);if(t.globalAlpha=u,t.fillStyle=l.color,l.shape==="circle"&&typeof t.beginPath=="function"&&typeof t.arc=="function"&&typeof t.fill=="function")t.beginPath(),t.arc(y,p,w,0,Xi),t.fill();else if(typeof t.fillRect=="function"){const P=w;t.fillRect(y-P,p-P,w*2,w*2)}}t.globalAlpha=o,t.fillStyle=h}clear(){for(let t=0;t<this.capacity;t+=1){const e=this.particles[t];e.active=!1,e.life=0,e.maxLife=0,this.activeLookup[t]=-1,this.freeIndices[t]=this.capacity-1-t}this.activeCount=0,this.freeTop=this.capacity-1}getActiveCount(){return this.activeCount}}$t=new WeakSet,Ws=function(t){const e=this.activeIndices[t],s=this.activeCount-1;if(t!==s){const n=this.activeIndices[s];this.activeIndices[t]=n,this.activeLookup[n]=t}this.activeCount=s,this.activeLookup[e]=-1;const i=this.particles[e];i.active=!1,i.life=0,this.freeTop+=1,this.freeIndices[this.freeTop]=e};function U(r){return typeof r=="number"&&Number.isFinite(r)}function ft(r,t=0){if(!U(r))return t;const e=Math.floor(r);return e>=0?e:t}function z(r,t=0){return U(r)&&r>0?r:t}class te{constructor(t,e={}){this.source=String(t??""),this.frameWidth=z(e.frameWidth,0),this.frameHeight=z(e.frameHeight,0),this.columns=ft(e.columns,0),this.rows=ft(e.rows,0),this.fallbackColor=e.fallbackColor||"#ff00ff",this.image=null,this._ready=!1,this._error=null,this._loadPromise=null,this._loadToken=0,this._loadingSource="",this._namedFrames=new Map}async load(){if(this._ready&&this.image)return!0;if(this._loadPromise&&this._loadingSource===this.source)return this._loadPromise;const t=++this._loadToken;this._loadingSource=this.source;const e=new Promise(s=>{if(!this.source||typeof Image>"u"){t===this._loadToken&&(this._ready=!1,this._error=new Error("SpriteSheet image loading is unavailable."),this._loadPromise=null),s(!1);return}const i=new Image;this.image=i;let n=!1;const o=(h,a)=>{if(!n){if(n=!0,t!==this._loadToken){s(!1);return}i.onload=null,i.onerror=null,this._ready=h,this._error=h?null:a||new Error("SpriteSheet image failed to load."),h&&(!this.columns&&this.frameWidth>0&&(this.columns=Math.floor(i.naturalWidth/this.frameWidth)),!this.rows&&this.frameHeight>0&&(this.rows=Math.floor(i.naturalHeight/this.frameHeight))),this._loadPromise=null,s(h)}};i.onload=()=>o(!0,null),i.onerror=()=>o(!1,new Error(`SpriteSheet load failed: ${this.source}`));try{i.src=this.source}catch(h){const a=h instanceof Error?h:new Error(String(h));o(!1,a)}i.complete&&(i.naturalWidth>0&&i.naturalHeight>0?o(!0,null):o(!1,new Error(`SpriteSheet load failed: ${this.source}`)))});return this._loadPromise=e,e}isReady(){return this._ready}setNamedFrames(t){if(this._namedFrames.clear(),!!t){if(t instanceof Map){for(const[e,s]of t.entries())this._namedFrames.set(String(e),s);return}if(typeof t=="object")for(const[e,s]of Object.entries(t))this._namedFrames.set(String(e),s)}}getNamedFrameRect(t){return this._resolveNamedFrameRect(String(t),new Set)}getFrameRectByIndex(t){const e=this._getColumns(),s=this._getRows(),i=ft(t,-1);if(i<0||e<=0||s<=0)return null;const n=e*s;if(i>=n)return null;const o=Math.floor(i/e),h=i%e;return this.getFrameRect(o,h)}getFrameRect(t,e){const s=this._getColumns(),i=this._getRows(),n=ft(t,-1),o=ft(e,-1);if(n<0||o<0||s<=0||i<=0||n>=i||o>=s||this.frameWidth<=0||this.frameHeight<=0)return null;const h=n*s+o;return{x:o*this.frameWidth,y:n*this.frameHeight,width:this.frameWidth,height:this.frameHeight,row:n,col:o,index:h}}drawFrame(t,e,s,i,n,o){if(!t)return!1;const h=this._resolveFrameSelector(i),a=h?h.width:this.frameWidth,l=h?h.height:this.frameHeight,u=z(n,z(a,0)),c=z(o,z(l,0));if(this._ready&&!this._error&&this.image&&h&&typeof t.drawImage=="function"&&u>0&&c>0)try{return t.drawImage(this.image,h.x,h.y,h.width,h.height,e,s,u,c),!0}catch{}if(typeof t.fillRect=="function"&&u>0&&c>0)if(typeof t.save=="function"&&typeof t.restore=="function")t.save(),t.fillStyle=this.fallbackColor,t.fillRect(e,s,u,c),t.restore();else{const p=t.fillStyle;t.fillStyle=this.fallbackColor,t.fillRect(e,s,u,c),t.fillStyle=p}return!1}_resolveFrameSelector(t){if(typeof t=="number")return this.getFrameRectByIndex(t);if(typeof t=="string")return this.getNamedFrameRect(t);if(Array.isArray(t)&&t.length>=2)return this.getFrameRect(t[0],t[1]);if(t&&typeof t=="object"){if(U(t.x)&&U(t.y)&&U(t.width)&&U(t.height)){const e=z(t.width,0),s=z(t.height,0);return e<=0||s<=0?null:{x:t.x,y:t.y,width:e,height:s}}if(U(t.index))return this.getFrameRectByIndex(t.index);if(U(t.row)&&U(t.col))return this.getFrameRect(t.row,t.col)}return null}_resolveNamedFrameRect(t,e){if(!t||!this._namedFrames.has(t)||e.has(t))return null;e.add(t);const s=this._namedFrames.get(t);return typeof s=="string"&&this._namedFrames.has(s)?this._resolveNamedFrameRect(s,e):this._resolveFrameSelector(s)}_getColumns(){return this.columns>0?this.columns:this._ready&&this.image&&this.frameWidth>0?Math.floor(this.image.naturalWidth/this.frameWidth):0}_getRows(){return this.rows>0?this.rows:this._ready&&this.image&&this.frameHeight>0?Math.floor(this.image.naturalHeight/this.frameHeight):0}}const ee="idle",Ze=r=>r!==null&&typeof r=="object",zi=r=>{if(!Ze(r))return{};const t={};for(const[e,s]of Object.entries(r)){if(!Ze(s))continue;const i=Array.isArray(s.frames)?s.frames:[],n=Number(s.fps);t[e]={frames:i,fps:Number.isFinite(n)&&n>0?n:0,loop:!!s.loop,onComplete:typeof s.onComplete=="function"?s.onComplete:void 0}}return t};class Ki{constructor(t={},e=ee){this.animations={},this.currentState=null,this.currentFrameIndex=0,this.elapsedSeconds=0,this.playing=!1,this.completed=!1,this.setAnimations(t),this.play(e,{reset:!0})}setAnimations(t){this.animations=zi(t);const e=this.resolveState(this.currentState);if(!e)return this.currentState=null,this.currentFrameIndex=0,this.elapsedSeconds=0,this.playing=!1,this.completed=!1,this;if(e!==this.currentState)return this.currentState=e,this.resetPlayback(),this;const s=this.getAnimation(this.currentState);return!s||s.frames.length===0||s.fps<=0?(this.currentFrameIndex=0,this.elapsedSeconds=0,this.playing=!1,this.completed=!1,this):(this.currentFrameIndex=Math.min(this.currentFrameIndex,s.frames.length-1),s.loop?this.completed=!1:this.completed&&(this.playing=!1),this)}play(t,{reset:e=!1}={}){const s=this.resolveState(t);if(!s)return this;if(s!==this.currentState)return this.currentState=s,this.resetPlayback(),this;if(e)return this.resetPlayback(),this;const i=this.getAnimation(this.currentState);return!i||i.frames.length===0||i.fps<=0?(this.playing=!1,this):((i.loop||!this.completed)&&(this.playing=!0),this)}stop(){return this.playing=!1,this}update(t){if(!this.playing)return this;const e=this.getAnimation(this.currentState);if(!e||e.frames.length===0||e.fps<=0)return this.currentFrameIndex=0,this.elapsedSeconds=0,this.playing=!1,this.completed=!1,this;const s=Number(t);if(!Number.isFinite(s)||s<=0)return this;const i=1/e.fps;if(e.loop){const o=i*e.frames.length;return o<=0?(this.currentFrameIndex=0,this):(this.elapsedSeconds=(this.elapsedSeconds+s)%o,this.currentFrameIndex=Math.floor(this.elapsedSeconds/i),this.completed=!1,this)}const n=i*e.frames.length;return this.elapsedSeconds=Math.min(n,this.elapsedSeconds+s),this.currentFrameIndex=Math.min(e.frames.length-1,Math.floor(this.elapsedSeconds/i)),this.elapsedSeconds>=n&&(this.playing=!1,this.completed||(this.completed=!0,typeof e.onComplete=="function"&&e.onComplete())),this}getCurrentFrame(){const t=this.getAnimation(this.currentState);if(!t||t.frames.length===0)return null;const e=Math.min(this.currentFrameIndex,t.frames.length-1);return t.frames[e]??null}getCurrentState(){return this.currentState}isPlaying(){return this.playing}getAnimation(t){return typeof t!="string"?null:this.animations[t]??null}resolveState(t){return typeof t=="string"&&this.animations[t]?t:typeof this.currentState=="string"&&this.animations[this.currentState]?this.currentState:this.animations[ee]?ee:null}resetPlayback(){this.currentFrameIndex=0,this.elapsedSeconds=0,this.playing=!0,this.completed=!1}}class vt{constructor(t,e){if(typeof t!="function")throw new TypeError("ObjectPool factory must be a function");if(e!==void 0&&typeof e!="function")throw new TypeError("ObjectPool reset must be a function");this._factory=t,this._reset=e,this._available=[],this._availableSet=new Set,this._active=new Set,this._all=new Set}get size(){return this._all.size}get activeCount(){return this._active.size}acquire(){let t;return this._available.length>0?(t=this._available.pop(),this._availableSet.delete(t)):(t=this._factory(),this._all.add(t)),this._active.add(t),t}preallocate(t){const e=Number.isFinite(t)?Math.max(0,Math.floor(t)):0;for(let s=0;s<e;s+=1){const i=this._factory();this._all.add(i),this._availableSet.has(i)||(this._available.push(i),this._availableSet.add(i))}}release(t){this._active.has(t)&&(this._active.delete(t),this._reset&&this._reset(t),this._availableSet.has(t)||(this._available.push(t),this._availableSet.add(t)))}clear(){this._available.length=0,this._availableSet.clear(),this._active.clear(),this._all.clear()}}const Gi={padding:16,gap:10,panelWidthLeft:194,panelWidthRight:178,rightInset:0,rowHeight:24,rowPaddingX:14,panelPaddingTop:12,panelPaddingBottom:10,panelRadius:12,panelFill:"rgba(10, 16, 30, 0.74)",panelStroke:"rgba(140, 166, 210, 0.65)",labelColor:"#d4deef",valueColor:"#f3f8ff",font:"600 15px Arial",healthBarWidth:220,healthBarHeight:14,healthBarOffsetY:18,healthBarRadius:7,healthBarLabelColor:"#d4deef",healthBarFillColor:"#36d37e",healthBarBackColor:"rgba(13, 28, 50, 0.9)",healthBarStrokeColor:"rgba(157, 191, 255, 0.65)",healthBarCriticalColor:"#f97373"};class $i{constructor(t={}){const e=t&&typeof t=="object"?t:{};this.visible=e.visible!==!1,this.state=e.state&&typeof e.state=="object"?{...e.state}:{},this.style={...Gi,...e.style&&typeof e.style=="object"?e.style:{}}}setState(t){this.state=t&&typeof t=="object"?{...t}:{}}setVisible(t){this.visible=t!==!1}render(t,e){if(!this.visible||!t||typeof t.save!="function")return;const s=qt(t);if(s.width<=0||s.height<=0)return;const i=e&&typeof e=="object"?e:this.state,n=[{label:"Dodged",value:N(i,["dodges","dodged","bulletsDodged"])},{label:"Deaths",value:N(i,["deaths"])},{label:"Kills",value:N(i,["kills"])}],o=[{label:"Wave",value:N(i,["wave","currentWave"])},{label:"Score",value:N(i,["score"])}],h=this.style.panelPaddingTop+this.style.panelPaddingBottom+n.length*this.style.rowHeight,a=this.style.panelPaddingTop+this.style.panelPaddingBottom+o.length*this.style.rowHeight,l=this.style.padding,u=this.style.padding,c=s.width-this.style.padding-m(this.style.rightInset,0)-this.style.panelWidthRight;t.save(),this._drawPanel(t,l,u,this.style.panelWidthLeft,h,n),this._drawPanel(t,c,u,this.style.panelWidthRight,a,o),this._drawHealthBar(t,s,i,h,a),t.restore()}_drawPanel(t,e,s,i,n,o){if(!(!t||i<=0||n<=0)){J(t,e,s,i,n,m(this.style.panelRadius,10)),t.fillStyle=this.style.panelFill,t.fill(),t.lineWidth=2,t.strokeStyle=this.style.panelStroke,t.stroke(),t.font=this.style.font,t.textBaseline="middle";for(let h=0;h<o.length;h+=1){const a=o[h]||{},l=s+this.style.panelPaddingTop+h*this.style.rowHeight+this.style.rowHeight/2;t.textAlign="left",t.fillStyle=this.style.labelColor,t.fillText(String(a.label||""),e+this.style.rowPaddingX,l),t.textAlign="right",t.fillStyle=this.style.valueColor,t.fillText(Ne(m(a.value,0)),e+i-this.style.rowPaddingX,l)}}}_drawHealthBar(t,e,s,i,n){const o=Math.max(0,N(s,["health"],0)),h=Math.max(1,N(s,["maxHealth"],1)),a=E(o/h,0,1),l=E(m(this.style.healthBarWidth,220),140,Math.max(140,e.width-this.style.padding*2)),u=E(m(this.style.healthBarHeight,14),10,24),c=this.style.padding+Math.max(i,n)+m(this.style.healthBarOffsetY,18),y=Math.max(this.style.padding,e.height-this.style.padding-u),p=E(c,this.style.padding,y),w=(e.width-l)*.5,P=E(m(this.style.healthBarRadius,7),0,u*.5);J(t,w,p,l,u,P),t.fillStyle=this.style.healthBarBackColor,t.fill(),t.lineWidth=2,t.strokeStyle=this.style.healthBarStrokeColor,t.stroke(),a>0&&(J(t,w,p,l*a,u,P),t.fillStyle=a<=.3?this.style.healthBarCriticalColor:this.style.healthBarFillColor,t.fill());const R=p-6,q=p+u+14,Y=R>=this.style.padding?R:q;Y<=e.height-this.style.padding&&(t.textBaseline="alphabetic",t.font="600 13px Arial",t.fillStyle=this.style.healthBarLabelColor,t.textAlign="left",t.fillText("HP",w,Y),t.textAlign="right",t.fillText(`${Math.round(o)}/${Math.round(h)}`,w+l,Y))}}const qi={baseFill:"rgba(20, 28, 44, 0.3)",baseStroke:"rgba(154, 176, 213, 0.8)",deadzoneStroke:"rgba(120, 142, 178, 0.45)",knobFill:"rgba(97, 160, 255, 0.9)",knobStroke:"rgba(240, 248, 255, 0.9)",activeGlow:"rgba(130, 180, 255, 0.35)",lineWidth:2};class Qi{constructor(t={}){const e=t&&typeof t=="object"?t:{};this.x=m(e.x,0),this.y=m(e.y,0),this.radius=Math.max(1,m(e.radius,56)),this.knobRadius=Math.max(1,m(e.knobRadius,this.radius*.43)),this.deadzone=E(m(e.deadzone,.16),0,.95),this.activationRadius=Math.max(this.radius,m(e.activationRadius,this.radius*1.25)),this.visible=e.visible!==!1,this.enabled=e.enabled!==!1,this.style={...qi,...e.style&&typeof e.style=="object"?e.style:{}},this.pointerId=null,this.active=!1,this.rawX=0,this.rawY=0,this.valueX=0,this.valueY=0}setCenter(t,e){this.x=m(t,this.x),this.y=m(e,this.y)}setRadius(t,e){this.radius=Math.max(1,m(t,this.radius)),this.knobRadius=Math.max(1,m(e,this.radius*.43)),this.activationRadius=Math.max(this.radius,this.activationRadius),this._applyVector(this.rawX*this.radius,this.rawY*this.radius)}setDeadzone(t){this.deadzone=E(m(t,this.deadzone),0,.95),this._applyVector(this.rawX*this.radius,this.rawY*this.radius)}setEnabled(t){this.enabled=t!==!1,this.enabled||this.reset()}setVisible(t){this.visible=t!==!1,this.visible||this.reset()}getValue(){return{x:this.valueX,y:this.valueY}}get xAxis(){return this.valueX}get yAxis(){return this.valueY}containsPoint(t,e){if(!this.visible)return!1;const s=m(t,NaN),i=m(e,NaN);return!Number.isFinite(s)||!Number.isFinite(i)?!1:Math.hypot(s-this.x,i-this.y)<=this.activationRadius}handlePointerDown(t,e,s){if(!this.enabled||!this.visible||this.active)return!1;const i=$(t,e,s);return!i||!this.containsPoint(i.x,i.y)?!1:(this.active=!0,this.pointerId=i.id,this._applyVector(i.x-this.x,i.y-this.y),!0)}handlePointerMove(t,e,s){if(!this.active)return!1;const i=$(t,e,s);return!i||i.id!==this.pointerId?!1:(this._applyVector(i.x-this.x,i.y-this.y),!0)}handlePointerUp(t,e,s){if(!this.active)return!1;const i=$(t,e,s);return!i||i.id!==this.pointerId?!1:(this.reset(),!0)}handlePointerCancel(t,e,s){return this.handlePointerUp(t,e,s)}reset(){this.pointerId=null,this.active=!1,this.rawX=0,this.rawY=0,this.valueX=0,this.valueY=0}render(t){if(!t||typeof t.save!="function"||!this.visible||this.radius<=0)return;const e=this.radius*this.deadzone,s=this.x+this.rawX*this.radius,i=this.y+this.rawY*this.radius;t.save(),this.active&&(t.fillStyle=this.style.activeGlow,t.beginPath(),t.arc(this.x,this.y,this.radius*1.25,0,Math.PI*2),t.fill()),t.fillStyle=this.style.baseFill,t.strokeStyle=this.style.baseStroke,t.lineWidth=m(this.style.lineWidth,2),t.beginPath(),t.arc(this.x,this.y,this.radius,0,Math.PI*2),t.fill(),t.stroke(),e>0&&(t.strokeStyle=this.style.deadzoneStroke,t.beginPath(),t.arc(this.x,this.y,e,0,Math.PI*2),t.stroke()),t.fillStyle=this.style.knobFill,t.strokeStyle=this.style.knobStroke,t.beginPath(),t.arc(s,i,this.knobRadius,0,Math.PI*2),t.fill(),t.stroke(),t.restore()}_applyVector(t,e){const s=Math.hypot(t,e),i=Math.max(1,this.radius);let n=m(t,0),o=m(e,0);if(s>i&&s>0){const u=i/s;n*=u,o*=u}this.rawX=E(n/i,-1,1),this.rawY=E(o/i,-1,1);const h=Math.hypot(this.rawX,this.rawY);if(h<=this.deadzone||h===0){this.valueX=0,this.valueY=0;return}const l=(h-this.deadzone)/(1-this.deadzone)/h;this.valueX=E(this.rawX*l,-1,1),this.valueY=E(this.rawY*l,-1,1)}}const se=1600,ts=3,ie=56,Ji=760,Zi=430,es=2200,At=120,tn=84,en=1.75,sn=1.7,nn=Object.freeze({[b.GRUNT]:0,[b.SNIPER]:1,[b.RUSHER]:2,[b.TANK]:3,[b.BOSS]:3}),rn=Object.freeze({[b.GRUNT]:"#ef476f",[b.SNIPER]:"#ff7f50",[b.RUSHER]:"#f2c14e",[b.TANK]:"#e63946",[b.BOSS]:"#e63946"}),ne=()=>{var r,t;return!!((t=(r=import.meta)==null?void 0:r.env)!=null&&t.DEV)},Nt=()=>typeof performance<"u"?performance.now():Date.now(),et=(r,t,e)=>{var s;return(s=r==null?void 0:r.emit)==null?void 0:s.call(r,t,e)},Et=r=>({x:r.x+r.width*.5,y:r.y+r.height*.5});class on{constructor(){this.player=null,this.enemies=[],this.bullets=[],this.playerBullets=[],this.enemyBullets=[],this.platforms=[],this.worldWidth=se,this.groundY=0,this.spawnPoints=[],this.assetsReady=!1,this.assetsError=null,this.assetsErrorLogged=!1,this.fallbackMode=!1,this.preloadPromise=null,this.enemyPool=new vt(()=>new Is,t=>{var e;t&&((e=t.deactivate)==null||e.call(t),t.x=-9999,t.y=-9999,t.vx=0,t.vy=0,t.moveIntent=0,t.state="idle")}),this.playerBulletPool=new vt(()=>new jt,t=>{var e;return(e=t==null?void 0:t.reset)==null?void 0:e.call(t)}),this.enemyBulletPool=new vt(()=>new jt,t=>{var e;return(e=t==null?void 0:t.reset)==null?void 0:e.call(t)}),this.enemyPool.preallocate(40),this.playerBulletPool.preallocate(80),this.enemyBulletPool.preallocate(80),this.aiSystem=new Ii,this.physicsSystem=new As,this.collisionSystem=new xi,this.spawnSystem=new $e({enemyPool:this.enemyPool}),this.systemPipeline=[this.aiSystem,this.physicsSystem,this.collisionSystem,this.spawnSystem],this.systemContext={players:[],enemies:this.enemies,bullets:this.bullets,platforms:this.platforms,eventBus:null,nowMs:0,enemyPool:this.enemyPool,spawnPoints:this.spawnPoints,autoStart:!1},this.scoreSystem=null,this.hudState={},this.hud=new $i({style:{rightInset:tn}}),this.joystick=new Qi,this.jumpButton=new ut({label:"JMP"}),this.shootButton=new ut({label:"SHT"}),this.pauseButton=new ut({label:"II"}),this.pointerOwners=new Map,this.pauseRequested=!1,this.jumpQueued=!1,this.shootQueued=!1,this.shootHeld=!1,this.jumpWasHeld=!1,this.eventOff=[],this.keyBound=!1,this.onKeyDown=t=>{(t.code==="Escape"||t.code==="KeyP")&&(this.pauseRequested=!0)},this.background=null,this.particles=new Vi(220),this.playerSheet=null,this.enemySheet=null,this.bulletSheet=null,this.runStartedAtMs=0,this.elapsedMs=0,this.playerAnimator=new Ki({idle:{frames:[0],fps:4,loop:!0},run:{frames:[1],fps:8,loop:!0},jump:{frames:[2],fps:8,loop:!0},fall:{frames:[3],fps:8,loop:!0}},"idle")}onEnter(t,e={}){var i,n;const s=(e==null?void 0:e.payload)??e??{};this.preloadPromise||(this.preloadPromise=this.preloadAssets()),(!this.player||s.restart===!0)&&this.resetRun(t),this.layout(t.viewWidth,t.viewHeight),this.player&&this.updateStaticLevelGeometry(t.viewHeight||1),(n=(i=t.input)==null?void 0:i.setTouchControlsEnabled)==null||n.call(i,!1),this.keyBound||(window.addEventListener("keydown",this.onKeyDown),this.keyBound=!0),this.bindEvents(t.eventBus),t.camera.follow(this.player,ot)}onExit(t){var e,s;this.unbindEvents(),(s=(e=t==null?void 0:t.input)==null?void 0:e.setTouchControlsEnabled)==null||s.call(e,!0),this.keyBound&&(window.removeEventListener("keydown",this.onKeyDown),this.keyBound=!1),this.pointerOwners.clear(),this.joystick.reset(),this.jumpButton.reset(),this.shootButton.reset(),this.pauseButton.reset()}onResize(t,e){this.layout(t,e),this.player&&(this.player.y=Math.min(this.player.y,this.groundY-this.player.height)),this.player&&this.updateStaticLevelGeometry(e)}async preloadAssets(){this.assetsReady=!1,this.assetsError=null,this.assetsErrorLogged=!1,this.playerSheet=new te("/sprites/player_sheet.svg",{frameWidth:64,frameHeight:64,columns:4,rows:1}),this.enemySheet=new te("/sprites/enemy_sheet.svg",{frameWidth:64,frameHeight:64,columns:4,rows:1}),this.bulletSheet=new te("/sprites/bullets.svg",{frameWidth:24,frameHeight:32,columns:5,rows:1});try{const t=await Promise.all([this.playerSheet.load(),this.enemySheet.load(),this.bulletSheet.load()]);this.fallbackMode=!t.every(Boolean),this.fallbackMode&&ne()&&console.warn("[GameScene] Sprite preload incomplete. Falling back to shape rendering.")}catch(t){this.assetsError=t,this.fallbackMode=!0,ne()&&(console.error("[GameScene] Sprite preload failed. Falling back to shape rendering.",t),this.assetsErrorLogged=!0)}finally{this.assetsReady=!0}}resetRun(t){var e,s;this.worldWidth=Math.max(se,(t.viewWidth||1)*ts),this.groundY=(t.viewHeight||1)-ie,this.releaseRunObjects(),this.player=new yt({x:220,y:this.groundY-40,width:28,height:40}),this.player.isPlayer=!0,this.updateStaticLevelGeometry(t.viewHeight||1,!1),this.enemies=[],this.bullets=[],this.playerBullets=[],this.enemyBullets=[],this.background=new ji(this.buildBackgroundLayers(t.viewHeight||1),"#9ab0d4"),this.spawnSystem=new $e({enemyPool:this.enemyPool}),this.systemPipeline=[this.aiSystem,this.physicsSystem,this.collisionSystem,this.spawnSystem],(s=(e=this.scoreSystem)==null?void 0:e.dispose)==null||s.call(e),this.scoreSystem=new Yi(t.eventBus),this.systemContext.players=this.player?[this.player]:[],this.systemContext.enemies=this.enemies,this.systemContext.bullets=this.bullets,this.systemContext.platforms=this.platforms,this.systemContext.spawnPoints=this.spawnPoints,this.systemContext.enemyPool=this.enemyPool,this.runStartedAtMs=Nt(),this.elapsedMs=0,this.pauseRequested=!1}releaseRunObjects(){const t=new Set,e=(s,i)=>{var n;!s||t.has(s)||(typeof s.deactivate=="function"&&s.deactivate(),(n=i==null?void 0:i.release)==null||n.call(i,s),t.add(s))};for(const s of this.enemies)e(s,this.enemyPool);for(const s of this.playerBullets)e(s,this.playerBulletPool);for(const s of this.enemyBullets)e(s,this.enemyBulletPool);for(const s of this.bullets){if(t.has(s))continue;const i=typeof(s==null?void 0:s.owner)=="string"&&s.owner.toLowerCase()==="player"?this.playerBulletPool:this.enemyBulletPool;e(s,i)}}bindEvents(t){this.unbindEvents(),this.eventOff.push(t.on("enemy_shoot",({enemy:e})=>this.fireEnemyBullet(e,t))),this.eventOff.push(t.on("enemy_killed",({enemy:e})=>{const s=Et(e);this.particles.burst(14,{x:s.x,y:s.y,life:.4,size:2,color:"#fca5a5"})}))}unbindEvents(){for(const t of this.eventOff)t==null||t();this.eventOff=[]}getLevelPlatforms(){return[{x:0,y:this.groundY,width:this.worldWidth,height:ie},{x:this.worldWidth*.28,y:this.groundY-170,width:280,height:28},{x:this.worldWidth*.62,y:this.groundY-220,width:300,height:28}]}applyPlatformLayout(t){for(let e=0;e<t.length;e+=1){const s=t[e];let i=this.platforms[e];i instanceof Ut?(i.x=s.x,i.y=s.y,i.width=s.width,i.height=s.height,i.active=!0):(i=new Ut(s.x,s.y,s.width,s.height),this.platforms[e]=i)}this.platforms.length=t.length}updateStaticLevelGeometry(t,e=!0){this.applyPlatformLayout(this.getLevelPlatforms()),this.spawnPoints=[{x:-40,y:this.groundY-80},{x:this.worldWidth*.35,y:this.groundY-260},{x:this.worldWidth+40,y:this.groundY-80}],e&&this.background&&this.background.setLayers(this.buildBackgroundLayers(t))}buildBackgroundLayers(t){return[{imageSrc:"/sprites/background_layer_1.svg",y:0,height:t,parallaxX:.2,parallaxY:0},{imageSrc:"/sprites/background_layer_2.svg",y:40,height:t,parallaxX:.45,parallaxY:0}]}layout(t,e){const s=Math.max(1,Number(t)||1),i=Math.max(1,Number(e)||1);this.worldWidth=Math.max(se,s*ts),this.groundY=i-ie;const n=Math.max(46,Math.min(68,s*.075)),o=18,h=Math.max(56,Math.min(74,s*.08));this.joystick.setCenter(o+n,i-o-n),this.joystick.setRadius(n,n*.46),this.jumpButton.setBounds(s-o-h*2-12,i-o-h,h,h),this.shootButton.setBounds(s-o-h,i-o-h,h,h),this.pauseButton.setBounds(s-o-56,o,56,42)}update(t,e){var l;if(this.assetsError&&ne()&&!this.assetsErrorLogged&&(console.error("[GameScene] Continuing in fallback mode after asset preload error.",this.assetsError),this.assetsErrorLogged=!0),!this.assetsReady||!this.player)return;const s=Nt();if(this.runStartedAtMs>0&&(this.elapsedMs=Math.max(0,s-this.runStartedAtMs)),this.pauseRequested){this.pauseRequested=!1,et(e.eventBus,"ui_click",{source:"pause"}),e.switchScene("pause",{resume:!0});return}const i=(e.input.isPressed("right")?1:0)-(e.input.isPressed("left")?1:0),n=this.joystick.getValue().x;this.player.moveIntent=Math.abs(n)>.08?n:i;const o=this.jumpButton.isPressed();o&&!this.jumpWasHeld&&(this.jumpQueued=!0),this.jumpWasHeld=o,(e.input.consumePressed("jump")||this.jumpQueued)&&(this.player.jumpRequested=!0,this.jumpQueued=!1),e.input.consumePressed("shoot")&&(this.shootQueued=!0),this.shootHeld=e.input.isPressed("shoot")||this.shootButton.isPressed(),this.firePlayerBullet(e),!this.spawnSystem.waveActive&&this.enemies.length===0&&this.spawnSystem.startWave(this.spawnSystem.currentWave+1);const h=this.buildSystemContext(e.eventBus,s);for(const u of this.systemPipeline)u&&typeof u.update=="function"&&u.update(t,h);this.player.update(t,h),this.playerAnimator.play(this.player.animationState||"idle"),this.playerAnimator.update(t);for(const u of this.enemies)(u==null?void 0:u.active)!==!1&&u.update(t,h);for(const u of this.bullets)(u==null?void 0:u.active)!==!1&&u.update(t,h),u&&(u.x<-At||u.x>this.worldWidth+At||u.y<-At*2||u.y>this.groundY+At*2)&&u.deactivate();if(this.recycleBullets(),this.particles.update(t),this.player.x<0&&(this.player.x=0),this.player.x>this.worldWidth-this.player.width&&(this.player.x=this.worldWidth-this.player.width),this.player.y>this.groundY+320&&this.player.active!==!1){const u=Number(this.player.health)||0,c=this.player.maxHealth;this.player.takeDamage(c);const y=Number(this.player.health)||0,p=this.player.active===!1||u>0&&y<=0;et(e.eventBus,"player_hit",{player:this.player,damage:c,source:"fall",isFatal:p,death:p,dead:p})}const a=this.buildHudState(s);if(this.player.active===!1){const u=Math.max(Number(((l=e.sceneData)==null?void 0:l.highScore)||0),a.score);e.sceneData={...e.sceneData,highScore:u,stats:{...a,highScore:u}},e.switchScene("game_over",{stats:e.sceneData.stats});return}this.hud.setState(a),e.camera.follow(this.player,ot)}buildSystemContext(t,e){const s=this.systemContext;return s.players.length=0,this.player&&s.players.push(this.player),s.enemies=this.enemies,s.bullets=this.bullets,s.platforms=this.platforms,s.eventBus=t,s.nowMs=e,s.enemyPool=this.enemyPool,s.spawnPoints=this.spawnPoints,s.autoStart=!1,s}buildHudState(t=Nt()){var l,u,c,y,p;const e=((u=(l=this.scoreSystem)==null?void 0:l.getState)==null?void 0:u.call(l))||{},s=Math.max(0,Math.round(Number(((c=this.spawnSystem)==null?void 0:c.currentWave)??0)||0)),i=Math.max(0,Math.round(Number(e.wave)||0)),n=Math.max(s,i),o=this.runStartedAtMs>0?Math.max(0,t-this.runStartedAtMs):Math.max(0,this.elapsedMs),h=Math.floor(o/1e3),a=this.hudState;return a.score=Number(e.score)||0,a.kills=Number(e.kills)||0,a.dodges=Number(e.dodges)||0,a.deaths=Number(e.deaths)||0,a.hits=Number(e.hits)||0,a.wave=n,a.currentWave=s,a.timeSeconds=h,a.health=((y=this.player)==null?void 0:y.health)||0,a.maxHealth=((p=this.player)==null?void 0:p.maxHealth)||1,a.fallbackMode=this.fallbackMode,a}firePlayerBullet(t){if(!(this.shootQueued||this.shootHeld)||this.player.active===!1)return;const s=Nt();if(!this.player.canShoot(s))return;const i=this.playerBulletPool.acquire(),n=Et(this.player);i.fire({x:n.x,y:n.y-4,directionX:this.player.facing>=0?1:-1,directionY:0,speed:Ji,damage:_s,owner:"player",lifetimeMs:es,color:"#3b82f6"}),this.player.markShot(s),this.playerBullets.push(i),this.bullets.push(i),this.shootQueued=!1,et(t.eventBus,"bullet_fired",{owner:"player",bullet:i})}fireEnemyBullet(t,e){if(!t||t.active===!1||!this.player||this.player.active===!1)return;const s=this.enemyBulletPool.acquire(),i=Et(t),n=Et(this.player),o=n.x-i.x,h=n.y-i.y,a=Math.hypot(o,h)||1;s.fire({x:i.x,y:i.y,directionX:o/a,directionY:h/a,speed:Zi,damage:Math.max(4,Number(t.damage)||8),owner:t,lifetimeMs:es,color:"#ef4444"}),this.enemyBullets.push(s),this.bullets.push(s),et(e,"bullet_fired",{owner:"enemy",bullet:s})}recycleBullets(){const t=(s,i)=>{let n=0;for(let o=0;o<s.length;o+=1){const h=s[o];if((h==null?void 0:h.active)!==!1){s[n]=h,n+=1;continue}i.release(h)}s.length=n};t(this.playerBullets,this.playerBulletPool),t(this.enemyBullets,this.enemyBulletPool);let e=0;for(let s=0;s<this.bullets.length;s+=1){const i=this.bullets[s];(i==null?void 0:i.active)!==!1&&(this.bullets[e]=i,e+=1)}this.bullets.length=e}getEnemySpriteFrame(t){return nn[t==null?void 0:t.type]??0}getEnemyOutlineColor(t){return rn[t==null?void 0:t.type]??"#ef476f"}renderActorSprite(t,e,s,i,n,o,h){if(!s||s.active===!1||!e)return;const a=Math.max(1,Number(o)||1),l=s.width*a,u=s.height*a,c=s.x-(l-s.width)*.5,y=s.y-(u-s.height),p=e.worldToScreen(c,y);!Number.isFinite(p==null?void 0:p.x)||!Number.isFinite(p==null?void 0:p.y)||(i==null||i.drawFrame(t,p.x,p.y,n,l,u),t.save(),t.lineWidth=2,t.strokeStyle=h,t.strokeRect(p.x,p.y,l,u),t.restore())}render(t,e,s){var i,n,o;if(!this.assetsReady){t.fillStyle="#0b1020",t.fillRect(0,0,s.viewWidth,s.viewHeight),t.fillStyle="#f8fafc",t.font="600 24px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("Loading assets...",s.viewWidth*.5,s.viewHeight*.5);return}(i=this.background)==null||i.render(t,s.camera,s.viewWidth,s.viewHeight);for(const h of this.platforms)h==null||h.render(t,s.camera);if(this.fallbackMode){for(const h of this.enemies)(h==null?void 0:h.active)!==!1&&h.render(t,s.camera);for(const h of this.bullets)(h==null?void 0:h.active)!==!1&&h.render(t,s.camera);((n=this.player)==null?void 0:n.active)!==!1&&this.player.render(t,s.camera)}else{this.renderActorSprite(t,s.camera,this.player,this.playerSheet,this.playerAnimator.getCurrentFrame(),en,"#4fc3f7");for(const h of this.enemies)(h==null?void 0:h.active)!==!1&&this.renderActorSprite(t,s.camera,h,this.enemySheet,this.getEnemySpriteFrame(h),sn,this.getEnemyOutlineColor(h));for(const h of this.bullets)if((h==null?void 0:h.active)!==!1){const a=s.camera.worldToScreen(h.x,h.y);(o=this.bulletSheet)==null||o.drawFrame(t,a.x,a.y,typeof h.owner=="string"?0:2,h.width,h.height)}}this.particles.render(t,s.camera),this.hud.render(t,this.hudState),this.joystick.render(t),this.jumpButton.render(t),this.shootButton.render(t),this.pauseButton.render(t)}handlePointerDown(t){const e=(t==null?void 0:t.id)??0;return this.pauseButton.handlePointerDown(t)?(this.pointerOwners.set(e,"pause"),!0):this.jumpButton.handlePointerDown(t)?(this.pointerOwners.set(e,"jump"),!0):this.shootButton.handlePointerDown(t)?(this.pointerOwners.set(e,"shoot"),!0):this.joystick.handlePointerDown(t)?(this.pointerOwners.set(e,"joystick"),!0):!1}handlePointerMove(t){const e=this.pointerOwners.get((t==null?void 0:t.id)??0);return e==="pause"?this.pauseButton.handlePointerMove(t):e==="jump"?this.jumpButton.handlePointerMove(t):e==="shoot"?this.shootButton.handlePointerMove(t):e==="joystick"?this.joystick.handlePointerMove(t):!1}handlePointerUp(t,e){const s=(t==null?void 0:t.id)??0,i=this.pointerOwners.get(s);return this.pointerOwners.delete(s),i==="pause"?(this.pauseButton.handlePointerUp(t)&&(this.pauseRequested=!0),!0):i==="jump"?(this.jumpButton.handlePointerUp(t)&&(this.jumpQueued=!0,et(e==null?void 0:e.eventBus,"ui_click",{source:"jump"})),!0):i==="shoot"?(this.shootButton.handlePointerUp(t)&&(this.shootQueued=!0,et(e==null?void 0:e.eventBus,"ui_click",{source:"shoot"})),!0):i==="joystick"?this.joystick.handlePointerUp(t):!1}handlePointerCancel(t){const e=(t==null?void 0:t.id)??0,s=this.pointerOwners.get(e);return this.pointerOwners.delete(e),s==="pause"?this.pauseButton.handlePointerCancel(t):s==="jump"?this.jumpButton.handlePointerCancel(t):s==="shoot"?this.shootButton.handlePointerCancel(t):s==="joystick"?this.joystick.handlePointerCancel(t):!1}}const Vt="left",zt="right",at="jump",lt="shoot",hn=[Vt,zt,at,lt],re=.25,ss=12,an=32,ln=140,un=240,is=24,ns=Object.freeze({KeyA:{playerIndex:0,action:Vt},KeyD:{playerIndex:0,action:zt},KeyW:{playerIndex:0,action:at},Space:{playerIndex:0,action:at},KeyJ:{playerIndex:0,action:lt},KeyX:{playerIndex:0,action:lt},ArrowLeft:{playerIndex:1,action:Vt},ArrowRight:{playerIndex:1,action:zt},ArrowUp:{playerIndex:1,action:at},Enter:{playerIndex:1,action:at},KeyL:{playerIndex:1,action:lt},Semicolon:{playerIndex:1,action:lt}});function st(){return{left:!1,right:!1,jump:!1,shoot:!1}}function Kt(r){return typeof r=="number"&&Number.isFinite(r)}function oe(r){if(!r||typeof r!="object")return null;const t=r.id??r.pointerId??r.identifier;return t==null?null:String(t)}function he(r){if(!r||typeof r!="object")return null;const t=r.x??r.clientX??r.pageX;return Kt(t)?t:null}function ae(r){if(!r||typeof r!="object")return null;const t=r.y??r.clientY??r.pageY;return Kt(t)?t:null}function pt(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}class cn{constructor(){this.attached=!1,this.players=[{keyboard:st(),touch:st(),pressed:st()},{keyboard:st(),touch:st(),pressed:st()}],this.pointerSessions=new Map,this.activePointerByPlayer=[null,null],this.playerInputs=[{isPressed:t=>this.isPressed(0,t),consumePressed:t=>this.consumePressed(0,t)},{isPressed:t=>this.isPressed(1,t),consumePressed:t=>this.consumePressed(1,t)}],this.emptyInput={isPressed:()=>!1,consumePressed:()=>!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this)}attach(){this.attached||typeof window>"u"||(window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.attached=!0)}detach(){this.attached&&typeof window<"u"&&(window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)),this.attached=!1,this.reset()}reset(){this.pointerSessions.clear(),this.activePointerByPlayer[0]=null,this.activePointerByPlayer[1]=null;for(const t of this.players)for(const e of hn)t.keyboard[e]=!1,t.touch[e]=!1,t.pressed[e]=!1}getPlayerInput(t){return t===0||t===1?this.playerInputs[t]:this.emptyInput}isPressed(t,e){const s=this.players[t];if(!s||typeof e!="string")return!1;this.updateShootHoldForPlayer(t,pt());const i=e.toLowerCase();return i===Vt?s.keyboard.left||s.touch.left:i===zt?s.keyboard.right||s.touch.right:i===at?s.keyboard.jump:i===lt?s.keyboard.shoot||s.touch.shoot:!1}consumePressed(t,e){const s=this.players[t];if(!s||typeof e!="string")return!1;this.updateShootHoldForPlayer(t,pt());const i=e.toLowerCase();if(!Object.prototype.hasOwnProperty.call(s.pressed,i))return!1;const n=s.pressed[i];return s.pressed[i]=!1,n}onKeyDown(t){const e=t!=null&&t.code?ns[t.code]:null;if(!e)return;const s=this.players[e.playerIndex];s.keyboard[e.action]||(s.keyboard[e.action]=!0,s.pressed[e.action]=!0),t.cancelable&&t.preventDefault()}onKeyUp(t){const e=t!=null&&t.code?ns[t.code]:null;e&&(this.players[e.playerIndex].keyboard[e.action]=!1,t.cancelable&&t.preventDefault())}handlePointerDown(t,e){const s=oe(t),i=he(t),n=ae(t),o=this.resolveViewWidth(e);if(s===null||i===null||n===null||o<=0||this.pointerSessions.has(s))return!1;const h=this.resolveTouchPlayer(i,o);if(h<0||this.activePointerByPlayer[h]!==null)return!1;const a=pt(),l={id:s,playerIndex:h,startX:i,startY:n,lastX:i,lastY:n,downAtMs:a,jumpTriggered:!1,shootHoldTriggered:!1,zoneWidth:o*re,viewWidth:o};return this.pointerSessions.set(s,l),this.activePointerByPlayer[h]=s,this.syncTouchMoveDirection(l),this.updateShootHold(l,a),!0}handlePointerMove(t,e){const s=oe(t);if(s===null)return!1;const i=this.pointerSessions.get(s);if(!i)return!1;const n=he(t),o=ae(t);n!==null&&(i.lastX=n),o!==null&&(i.lastY=o);const h=this.resolveViewWidth(e);return h>0&&(i.viewWidth=h,i.zoneWidth=h*re),this.syncTouchMoveDirection(i),!i.jumpTriggered&&i.startY-i.lastY>=an&&(i.jumpTriggered=!0,this.players[i.playerIndex].pressed.jump=!0),this.updateShootHold(i,pt()),!0}handlePointerUp(t){return this.releasePointer(t,!0)}handlePointerCancel(t){return this.releasePointer(t,!1)}resolveViewWidth(t){return Kt(t)&&t>0?t:typeof window<"u"&&Kt(window.innerWidth)&&window.innerWidth>0?window.innerWidth:0}resolveTouchPlayer(t,e){const s=e*re;return t<=s?0:t>=e-s?1:-1}syncTouchMoveDirection(t){const e=this.players[t.playerIndex],s=t.playerIndex===0?t.zoneWidth*.5:t.viewWidth-t.zoneWidth*.5,i=t.lastX-s;if(i<=-ss){e.touch.left=!0,e.touch.right=!1;return}if(i>=ss){e.touch.left=!1,e.touch.right=!0;return}e.touch.left=!1,e.touch.right=!1}updateShootHold(t,e){const s=this.players[t.playerIndex];if(!t.shootHoldTriggered&&e-t.downAtMs>=ln){t.shootHoldTriggered=!0,s.touch.shoot=!0,s.pressed.shoot=!0;return}s.touch.shoot=t.shootHoldTriggered}updateShootHoldForPlayer(t,e){const s=this.activePointerByPlayer[t];if(s===null)return;const i=this.pointerSessions.get(s);if(!i){this.activePointerByPlayer[t]=null,this.players[t].touch.shoot=!1;return}this.updateShootHold(i,e)}releasePointer(t,e){const s=oe(t);if(s===null)return!1;const i=this.pointerSessions.get(s);if(!i)return!1;const n=he(t),o=ae(t);n!==null&&(i.lastX=n),o!==null&&(i.lastY=o);const h=pt();this.updateShootHold(i,h);const a=h-i.downAtMs,l=Math.abs(i.lastX-i.startX),u=Math.abs(i.lastY-i.startY);e&&!i.shootHoldTriggered&&!i.jumpTriggered&&a<=un&&l<=is&&u<=is&&(this.players[i.playerIndex].pressed.shoot=!0),this.pointerSessions.delete(s),this.activePointerByPlayer[i.playerIndex]===s&&(this.activePointerByPlayer[i.playerIndex]=null);const c=this.players[i.playerIndex];return c.touch.left=!1,c.touch.right=!1,c.touch.shoot=!1,!0}}const we=2,I=-1,dn=new Set(["p1","player1","player_1","player-1"]),fn=new Set(["2","p2","player2","player_2","player-2"]);function rs(r){if(typeof r!="string")return I;const t=r.trim().toLowerCase();return t==="0"?0:t==="1"?1:dn.has(t)?0:fn.has(t)?1:I}function St(r,t=null){if(Array.isArray(t)){if(r===t[0])return 0;if(r===t[1])return 1}if(typeof r=="number"&&Number.isInteger(r)&&r>=0&&r<we)return r;const e=rs(r);if(e!==I)return e;if(!r||typeof r!="object")return I;const s=[r.playerIndex,r.index,r.slot,r.ownerIndex,r.killerIndex,r.victimIndex,r.targetIndex,r.dodgerIndex,r.shooterIndex,r.attackerIndex];for(const o of s){const h=St(o,t);if(h!==I)return h}const i=[r.id,r.playerId,r.name,r.label,r.team];for(const o of i){const h=rs(o);if(h!==I)return h}const n=[r.player,r.owner,r.entity,r.killer,r.victim,r.target,r.dodger,r.shooter,r.attacker];for(const o of n){const h=St(o,t);if(h!==I)return h}return I}function Rt(r,t,e=null){if(!r||typeof r!="object"||!Array.isArray(t))return I;for(const s of t){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=St(r[s],e);if(i!==I)return i}return I}const xt=r=>r&&typeof r=="object"&&M(r.x)&&M(r.y)&&M(r.width)&&M(r.height)&&Number(r.width)>=0&&Number(r.height)>=0,pn=r=>{!r||typeof r!="object"||(typeof r.deactivate=="function"?r.deactivate():r.active=!1,M(r.vx)&&(r.vx=0),M(r.vy)&&(r.vy=0))},os=r=>({x:Number(r.x)+Number(r.width)*.5,y:Number(r.y)+Number(r.height)*.5}),mn=(r,t)=>{const e=Number(r.x)+Number(r.width)/2,s=Number(r.y)+Number(r.height)/2,i=Number(t.x)+Number(t.width)/2,n=Number(t.y)+Number(t.height)/2,o=Number(r.width)/2+Number(t.width)/2,h=Number(r.height)/2+Number(t.height)/2,a=e-i,l=s-n;return{deltaX:a,deltaY:l,overlapX:o-Math.abs(a),overlapY:h-Math.abs(l)}};var H,Os,Hs,Ys,js;class yn{constructor(){L(this,H);this._players=[null,null]}update(t,e={}){const s=f(this,H,Os).call(this,e),i=Array.isArray(e==null?void 0:e.bullets)?e.bullets:[],n=Array.isArray(e==null?void 0:e.platforms)?e.platforms:[],o=e==null?void 0:e.eventBus;f(this,H,Hs).call(this,s,n),f(this,H,Ys).call(this,s,i,o)}}H=new WeakSet,Os=function(t){const e=Array.isArray(t==null?void 0:t.players)?t.players:[];return this._players[0]=(t==null?void 0:t.p1)??e[0]??null,this._players[1]=(t==null?void 0:t.p2)??e[1]??null,this._players},Hs=function(t,e){for(const s of t){if(!X(s)||!xt(s))continue;let i=!1;for(const n of e){if(!X(n)||!xt(n)||!D.aabbOverlap(s,n))continue;const{deltaX:o,deltaY:h,overlapX:a,overlapY:l}=mn(s,n);if(!(!(a>0)||!(l>0))){if(a<l){s.x+=o<0?-a:a,M(s.vx)&&(s.vx=0);continue}s.y+=h<0?-l:l,M(s.vy)&&(s.vy=0),h<0&&(i=!0)}}s.onGround=i}},Ys=function(t,e,s){for(const i of e){if(!X(i)||!xt(i))continue;const n=St(i==null?void 0:i.owner,t);if(n===I)continue;const o=n===0?1:0,h=t[n],a=t[o];if(!(!X(a)||!xt(a))){if(D.aabbOverlap(i,a)){const l=M(i.damage)?Math.max(0,Number(i.damage)):0,u=M(a.health)?Number(a.health):null,c=a.active!==!1;typeof a.takeDamage=="function"?a.takeDamage(l):M(a.health)&&(a.health=Math.max(0,Number(a.health)-l),a.health<=0&&(a.active=!1));const y=M(a.health)?Number(a.health):null,p=a.active===!1||u!==null&&y!==null&&u>0&&y<=0;pn(i),k(s,"bullet_hit",{bullet:i,target:a,shooter:h,shooterIndex:n,targetIndex:o,damage:l}),k(s,"versus:player_hit",{bullet:i,shooter:h,shooterIndex:n,target:a,targetIndex:o,damage:l,isFatal:p,death:p,dead:p}),c&&p&&k(s,"versus:kill",{bullet:i,killer:h,killerIndex:n,victim:a,victimIndex:o,damage:l});continue}f(this,H,js).call(this,i,h,n,a,o,s)}}},js=function(t,e,s,i,n,o){if(!X(t)||t.dodgeCounted===!0||!X(i))return;const h=os(i),a=os(t),l=M(t.previousX)?Number(t.previousX):Number(t.x),u=Number(t.x);if(!(l<=h.x&&u>=h.x||l>=h.x&&u<=h.x))return;const y=Number(i.height)*.65+Number(t.height)*1.5;Math.abs(a.y-h.y)>y||(t.dodgeCounted=!0,k(o,"versus:dodge",{bullet:t,shooter:e,shooterIndex:s,dodger:i,dodgerIndex:n}))};const Us=1500,mt=()=>({kills:0,deaths:0,dodges:0}),gn=(r,t=Us)=>{const e=Number(r);return Number.isFinite(e)?Math.max(0,e):t},wn=r=>!r||typeof r!="object"?!1:r.isFatal===!0||r.death===!0||r.dead===!0;var Z,Xs,ve;class vn{constructor(t,e={}){L(this,Z);this.eventBus=t??null,this.respawnDelayMs=gn(e==null?void 0:e.respawnDelayMs,Us),this._unsubscribeFns=[],this._stats=[mt(),mt()],this._respawnTimersMs=[null,null],f(this,Z,Xs).call(this)}update(t){const e=Number(t),s=Number.isFinite(e)&&e>0?e*1e3:0,i=[];if(s<=0)return i;for(let n=0;n<we;n+=1){const o=this._respawnTimersMs[n];if(!Number.isFinite(o))continue;const h=o-s;if(h>0){this._respawnTimersMs[n]=h;continue}this._respawnTimersMs[n]=null,i.push(n)}return i}getStats(t){const e=St(t);return e===I?mt():{...this._stats[e]}}reset(){this._stats[0]=mt(),this._stats[1]=mt(),this._respawnTimersMs[0]=null,this._respawnTimersMs[1]=null}dispose(){for(const t of this._unsubscribeFns)typeof t=="function"&&t();this._unsubscribeFns.length=0,this._respawnTimersMs[0]=null,this._respawnTimersMs[1]=null}}Z=new WeakSet,Xs=function(){!this.eventBus||typeof this.eventBus.on!="function"||(this._unsubscribeFns.push(this.eventBus.on("versus:dodge",t=>{const e=Rt(t,["dodgerIndex","targetIndex","playerIndex","index","dodger","target","player"]);e!==I&&(this._stats[e].dodges+=1)})),this._unsubscribeFns.push(this.eventBus.on("versus:kill",t=>{const e=Rt(t,["killerIndex","shooterIndex","attackerIndex","killer","shooter","attacker"]),s=Rt(t,["victimIndex","targetIndex","deadIndex","victim","target","player"]);e!==I&&(this._stats[e].kills+=1),s!==I&&(this._stats[s].deaths+=1,f(this,Z,ve).call(this,s))})),this._unsubscribeFns.push(this.eventBus.on("versus:player_hit",t=>{if(!wn(t))return;const e=Rt(t,["targetIndex","victimIndex","playerIndex","index","target","victim","player"]);e!==I&&f(this,Z,ve).call(this,e)})))},ve=function(t){t<0||t>=we||Number.isFinite(this._respawnTimersMs[t])||(this._respawnTimersMs[t]=this.respawnDelayMs)};const le=[{label:"BULLETS DODGED",keys:["bulletsDodged","dodges","dodged"]},{label:"DEATHS",keys:["deaths"]},{label:"KILLS",keys:["kills"]}],bn={inset:14,gap:14,panelMinWidth:184,panelMaxWidth:360,panelRadius:14,panelStrokeWidth:2,rowFont:"900 22px Arial",valueFont:"900 22px Arial",rowStartY:34,rowHeight:58,rowLabelInset:12,rowValueInset:12,shadowColor:"rgba(0, 0, 0, 0.28)",shadowBlur:10},Sn={panelFill:"rgba(176, 159, 162, 0.98)",panelTint:"rgba(189, 169, 170, 0.8)",panelStroke:"rgba(194, 174, 176, 0.95)",titleColor:"#fff0e5",labelColor:"#111111",valueColor:"#111111"},_n={panelFill:"rgba(138, 142, 197, 0.98)",panelTint:"rgba(152, 156, 209, 0.82)",panelStroke:"rgba(161, 165, 222, 0.95)",titleColor:"#f6f1ff",labelColor:"#111111",valueColor:"#111111"};class Pn{constructor(){this._state=[{},{}],this.style={...bn}}setState(t,e){const s=this._normalizePlayerIndex(t);this._state[s]=e&&typeof e=="object"?{...e}:{}}getState(t){const e=this._normalizePlayerIndex(t),s=this._state[e];return s&&typeof s=="object"?{...s}:{}}render(t,e,s){if(!t||typeof t.save!="function")return;const i=this._resolveView(t,e,s);if(i.width<=0||i.height<=0)return;const n=m(this.style.inset,14),o=m(this.style.gap,14),h=Math.max(0,(i.width-n*2-o)*.5),a=m(this.style.panelMinWidth,184),l=m(this.style.panelMaxWidth,360),u=h>=a?E(h,a,l):h,c=m(this.style.rowStartY,34)+le.length*m(this.style.rowHeight,24)+16,y=Math.max(n,i.width-n-u);t.save(),this._drawPanel(t,n,n,u,c,"P1",this._state[0],Sn),this._drawPanel(t,y,n,u,c,"P2",this._state[1],_n),t.restore()}_drawPanel(t,e,s,i,n,o,h,a){if(i<=0||n<=0)return;const l=m(this.style.panelRadius,14);J(t,e,s,i,n,l),t.save(),t.shadowColor=this.style.shadowColor,t.shadowBlur=m(this.style.shadowBlur,0),t.fillStyle=a.panelFill,t.fill(),t.restore(),t.fillStyle=a.panelTint,t.fillRect(e+2,s+2,Math.max(0,i-4),Math.max(0,n*.36)),t.lineWidth=m(this.style.panelStrokeWidth,2),t.strokeStyle=a.panelStroke,J(t,e,s,i,n,l),t.stroke();for(let u=0;u<le.length;u+=1){const c=le[u],y=s+m(this.style.rowStartY,34)+u*m(this.style.rowHeight,24);t.textAlign="left",t.font=this.style.rowFont,t.fillStyle=a.labelColor,t.fillText(c.label,e+m(this.style.rowLabelInset,12),y);const p=N(h,c.keys,0);t.textAlign="right",t.font=this.style.valueFont,t.fillStyle=a.valueColor,t.fillText(Ne(p),e+i-m(this.style.rowValueInset,12),y)}}_normalizePlayerIndex(t){return m(t,0)>=1?1:0}_resolveView(t,e,s){const i=m(e,NaN),n=m(s,NaN);return Number.isFinite(i)&&i>0&&Number.isFinite(n)&&n>0?{width:i,height:n}:qt(t)}}const Mn={radiusFactor:.048,minRadius:20,maxRadius:34,marginFactor:.55,hitRadiusScale:1.12,fillOn:"rgba(34, 95, 72, 0.94)",fillOff:"rgba(116, 55, 72, 0.95)",strokeOn:"rgba(173, 255, 218, 0.95)",strokeOff:"rgba(255, 191, 206, 0.95)",iconOn:"#e9fff5",iconOff:"#fff1f6",shadowColor:"rgba(0, 0, 0, 0.30)",shadowBlur:10};class Bn{constructor(){this._muted=!1,this.style={...Mn}}setMuted(t){this._muted=t===!0}isMuted(){return this._muted}render(t,e,s){if(!t||typeof t.save!="function")return;const i=this._resolveView(t,e,s);if(i.width<=0||i.height<=0)return;const n=this._getLayout(i.width,i.height),o=this._muted;t.save(),t.shadowColor=this.style.shadowColor,t.shadowBlur=m(this.style.shadowBlur,0),t.beginPath(),t.arc(n.cx,n.cy,n.radius,0,Math.PI*2),t.fillStyle=o?this.style.fillOff:this.style.fillOn,t.fill(),t.shadowBlur=0,t.lineWidth=2,t.strokeStyle=o?this.style.strokeOff:this.style.strokeOn,t.stroke(),this._drawIcon(t,n.cx,n.cy,n.radius,o),t.restore()}handlePointerUp(t,e,s){return this.contains(t,e,s)?(this._muted=!this._muted,!0):!1}contains(t,e,s){const i=$(t);if(!i)return!1;const n=m(e,NaN),o=m(s,NaN);if(!Number.isFinite(n)||n<=0||!Number.isFinite(o)||o<=0)return!1;const h=this._getLayout(n,o),a=h.radius*m(this.style.hitRadiusScale,1),l=i.x-h.cx,u=i.y-h.cy;return!(l*l+u*u>a*a)}_drawIcon(t,e,s,i,n){const o=i*.95;if(t.lineCap="round",t.lineJoin="round",t.lineWidth=Math.max(2,i*.12),t.strokeStyle=n?this.style.iconOff:this.style.iconOn,t.beginPath(),t.moveTo(e-o*.48,s-o*.18),t.lineTo(e-o*.28,s-o*.18),t.lineTo(e-o*.05,s-o*.38),t.lineTo(e-o*.05,s+o*.38),t.lineTo(e-o*.28,s+o*.18),t.lineTo(e-o*.48,s+o*.18),t.closePath(),t.stroke(),n){t.beginPath(),t.moveTo(e+o*.08,s-o*.42),t.lineTo(e+o*.54,s+o*.42),t.stroke();return}t.beginPath(),t.arc(e+o*.02,s,o*.34,-.85,.85),t.stroke(),t.beginPath(),t.arc(e+o*.02,s,o*.5,-.85,.85),t.stroke()}_getLayout(t,e){const s=Math.min(t,e)*m(this.style.radiusFactor,.048),i=E(s,m(this.style.minRadius,20),m(this.style.maxRadius,34)),n=E(i*m(this.style.marginFactor,.55),10,28);return{radius:i,cx:t-n-i,cy:e-n-i}}_resolveView(t,e,s){const i=m(e,NaN),n=m(s,NaN);return Number.isFinite(i)&&i>0&&Number.isFinite(n)&&n>0?{width:i,height:n}:qt(t)}}const hs=2200,as=22,ls="#245c13",Tn="#b7aea2",us="#aab7cc",In="rgba(153, 131, 188, 0.86)",cs=6,An=.26,Nn=150,En=230,ds=780,fs=2500,it=180,Rn=140,kt=28,Ct=40,ps=2,Ft=100,xn="#e33f3f",kn="#3f53d7",Cn=320,Fn=620,Ln=.34,ms=260,Dn=520,Wn=.22,On=90,Hn=220,Yn=.08,ys=.74,gs=.26,jn=5,Lt=()=>typeof performance<"u"?performance.now():Date.now(),Un=r=>({x:r.x+r.width*.5,y:r.y+r.height*.5});class Xn{constructor(){this.width=1,this.height=1,this.worldWidth=hs,this.platformY=0,this.groundY=0,this.players=[],this.p1=null,this.p2=null,this.spawnPoints=[{x:0,y:0},{x:0,y:0}],this.platforms=[],this.bullets=[],this.p1Bullets=[],this.p2Bullets=[],this.p1BulletPool=new vt(()=>new jt({width:16,height:6}),t=>{var e;return(e=t==null?void 0:t.reset)==null?void 0:e.call(t)}),this.p2BulletPool=new vt(()=>new jt({width:16,height:6}),t=>{var e;return(e=t==null?void 0:t.reset)==null?void 0:e.call(t)}),this.p1BulletPool.preallocate(24),this.p2BulletPool.preallocate(24),this.p1Camera=new ce(1,1),this.p2Camera=new ce(1,1),this.versusInput=new cn,this.physicsSystem=new As,this.collisionSystem=new yn,this.roundManager=null,this.versusHUD=new Pn,this.muteButton=new Bn,this.mutePointerId=null,this.settings=bt(),this.cachedNowMs=0,this.keyBound=!1,this.exitRequested=!1,this.matchEnded=!1,this.roundStartedAtMs=0,this.killsToWin=jn,this.gameInputWasAttached=!1,this.onKeyDown=t=>{const e=t==null?void 0:t.code;(e==="Escape"||e==="KeyP"||e==="Backspace")&&(this.exitRequested=!0,t!=null&&t.cancelable&&t.preventDefault())}}onEnter(t,e={}){var s,i,n,o,h,a,l,u,c,y,p;this.width=Math.max(1,Number(t==null?void 0:t.viewWidth)||1),this.height=Math.max(1,Number(t==null?void 0:t.viewHeight)||1),this.settings=bt(),(i=(s=t==null?void 0:t.audioManager)==null?void 0:s.setEnabled)==null||i.call(s,this.settings.soundEnabled),(o=(n=t==null?void 0:t.musicManager)==null?void 0:n.setEnabled)==null||o.call(n,this.settings.musicEnabled),this.muteButton.setMuted(!(this.settings.soundEnabled||this.settings.musicEnabled)),this.versusInput.attach(),this.versusInput.reset(),this.exitRequested=!1,this.matchEnded=!1,this.roundStartedAtMs=Lt(),this.gameInputWasAttached=!!((h=t==null?void 0:t.input)!=null&&h.attached),this.gameInputWasAttached&&((l=(a=t==null?void 0:t.input)==null?void 0:a.detach)==null||l.call(a)),(c=(u=t==null?void 0:t.input)==null?void 0:u.setTouchControlsEnabled)==null||c.call(u,!1),!this.keyBound&&typeof window<"u"&&(window.addEventListener("keydown",this.onKeyDown),this.keyBound=!0),this.layoutWorld(this.width,this.height),this.createOrResetPlayers(),this.resetBullets(),(p=(y=this.roundManager)==null?void 0:y.dispose)==null||p.call(y),this.roundManager=new vn(t==null?void 0:t.eventBus,{respawnDelayMs:1500}),this.roundManager.reset(),this.syncHudFromRoundManager(),this.p1Camera.setViewport(this.width*.5,this.height),this.p2Camera.setViewport(this.width*.5,this.height),this.p1Camera.follow(this.p1,ot),this.p2Camera.follow(this.p2,ot),this.p1Camera.update(),this.p2Camera.update(),this.clampCamera(this.p1Camera),this.clampCamera(this.p2Camera)}onExit(t){var e,s,i,n,o,h;this.versusInput.detach(),this.keyBound&&typeof window<"u"&&(window.removeEventListener("keydown",this.onKeyDown),this.keyBound=!1),this.exitRequested=!1,this.matchEnded=!1,this.roundStartedAtMs=0,this.gameInputWasAttached&&((s=(e=t==null?void 0:t.input)==null?void 0:e.attach)==null||s.call(e),this.gameInputWasAttached=!1),(n=(i=t==null?void 0:t.input)==null?void 0:i.setTouchControlsEnabled)==null||n.call(i,!0),(h=(o=this.roundManager)==null?void 0:o.dispose)==null||h.call(o),this.roundManager=null,this.mutePointerId=null,this.resetBullets()}onResize(t,e){this.width=Math.max(1,Number(t)||1),this.height=Math.max(1,Number(e)||1),this.layoutWorld(this.width,this.height),this.applySpawnIfOutOfBounds(this.p1,0),this.applySpawnIfOutOfBounds(this.p2,1),this.p1Camera.setViewport(this.width*.5,this.height),this.p2Camera.setViewport(this.width*.5,this.height)}layoutWorld(t,e){const s=Math.max(1,Number(t)||1),i=Math.max(1,Number(e)||1);this.groundY=Math.max(0,i-as),this.platformY=Math.max(80,Math.round(i*.84));const n=C(Math.round(s*Yn),On,Hn),o=C(Math.round(s*Ln),Cn,Fn);let h=C(Math.round(s*Wn),ms,Dn);const a=ds*fs/1e3,l=1+gs-ys,u=Math.max(420,a-Rn);if(h+o*l>u){const R=Math.floor(u-o*l);h=C(R,ms,h)}const y=o*2+h;this.worldWidth=Math.max(hs,y+n*2);const p=this.worldWidth*.5,w=Math.round(p-h*.5-o),P=Math.round(p+h*.5);this.applyPlatformLayout([{x:w,y:this.platformY,width:o,height:30,color:ls},{x:P,y:this.platformY,width:o,height:30,color:ls},{x:0,y:this.groundY,width:this.worldWidth,height:as,color:Tn}]),this.spawnPoints[0]={x:w+o*ys-kt*.5,y:this.platformY-Ct-ps},this.spawnPoints[1]={x:P+o*gs-kt*.5,y:this.platformY-Ct-ps}}applyPlatformLayout(t){for(let e=0;e<t.length;e+=1){const s=t[e];let i=this.platforms[e];i instanceof Ut?(i.x=s.x,i.y=s.y,i.width=s.width,i.height=s.height,i.color=s.color,i.active=!0):(i=new Ut(s.x,s.y,s.width,s.height,s.color),this.platforms[e]=i)}this.platforms.length=t.length}createOrResetPlayers(){this.p1 instanceof yt||(this.p1=new yt({width:kt,height:Ct,maxHealth:Ft,health:Ft,color:fe,markerColor:pe}),this.p1.playerIndex=0,this.p1.id="p1"),this.p2 instanceof yt||(this.p2=new yt({width:kt,height:Ct,maxHealth:Ft,health:Ft,color:li,markerColor:ui}),this.p2.playerIndex=1,this.p2.id="p2"),this.players=[this.p1,this.p2],this.respawnPlayer(0),this.respawnPlayer(1),this.p1.facing=1,this.p2.facing=-1}applySpawnIfOutOfBounds(t,e){t&&(t.x<-it||t.x>this.worldWidth+it||t.y>this.height+420||t.y<-420)&&this.respawnPlayer(e)}respawnPlayer(t){const e=this.players[t],s=this.spawnPoints[t];!e||!s||(e.x=s.x,e.y=s.y,e.vx=0,e.vy=0,e.active=!0,e.health=e.maxHealth,e.onGround=!1,e.moveIntent=0,e.jumpRequested=!1,e.lastShotAtMs=Number.NEGATIVE_INFINITY,e.facing=t===0?1:-1)}resetBullets(){const t=new Set,e=(s,i)=>{var n;!s||t.has(s)||((n=i==null?void 0:i.release)==null||n.call(i,s),t.add(s))};for(const s of this.p1Bullets)e(s,this.p1BulletPool);for(const s of this.p2Bullets)e(s,this.p2BulletPool);for(const s of this.bullets){if(t.has(s))continue;const i=(s==null?void 0:s.owner)===this.p1?this.p1BulletPool:this.p2BulletPool;e(s,i)}this.bullets.length=0,this.p1Bullets.length=0,this.p2Bullets.length=0}update(t,e){var l,u,c,y,p;if(this.exitRequested){this.exitRequested=!1,(u=(l=e==null?void 0:e.eventBus)==null?void 0:l.emit)==null||u.call(l,"ui_click",{source:"versus_exit"}),(c=e==null?void 0:e.switchScene)==null||c.call(e,"menu",{from:"versus"});return}const s=Number.isFinite(t)&&t>0?t:0;if(s<=0||!this.p1||!this.p2||this.matchEnded)return;this.cachedNowMs=Lt();const i=this.versusInput.getPlayerInput(0),n=this.versusInput.getPlayerInput(1);this.p1.applyInput(i,s),this.p2.applyInput(n,s),(i.consumePressed("shoot")||i.isPressed("shoot"))&&this.fireBullet(this.p1,0,e==null?void 0:e.eventBus),(n.consumePressed("shoot")||n.isPressed("shoot"))&&this.fireBullet(this.p2,1,e==null?void 0:e.eventBus);const o={players:this.players,enemies:[],bullets:this.bullets,platforms:this.platforms};this.physicsSystem.update(s,o),this.collisionSystem.update(s,{p1:this.p1,p2:this.p2,players:this.players,bullets:this.bullets,platforms:this.platforms,eventBus:e==null?void 0:e.eventBus});for(const w of this.players)w.update(s,o),w.x=C(w.x,0,this.worldWidth-w.width);for(const w of this.bullets)(w==null?void 0:w.active)!==!1&&w.update(s,o),!(!w||w.active===!1)&&(w.x<-it||w.x>this.worldWidth+it||w.y<-it||w.y>this.height+it)&&w.deactivate();this.recycleBullets();const h=this.getTerminalResult();if(h){this.finishMatch(e,h);return}const a=((p=(y=this.roundManager)==null?void 0:y.update)==null?void 0:p.call(y,s))??[];for(const w of a)this.respawnPlayer(w);this.syncHudFromRoundManager(),this.updateCameras()}fireBullet(t,e,s){var y;if(!t||t.active===!1)return!1;const i=this.cachedNowMs||Lt();if(!t.canShoot(i))return!1;const n=e===0?this.p1BulletPool:this.p2BulletPool,o=e===0?this.p1Bullets:this.p2Bullets,h=e===0?1:-1,a=t.facing<0?-1:t.facing>0?1:h,l=e===0?xn:kn,u=Un(t),c=n.acquire();return c.fire({x:u.x+a*(t.width*.45),y:u.y-3,directionX:a,directionY:0,speed:ds,damage:_s,owner:t,lifetimeMs:fs,color:l,shape:"rect"}),t.markShot(i),o.push(c),this.bullets.push(c),(y=s==null?void 0:s.emit)==null||y.call(s,"bullet_fired",{owner:e,bullet:c}),!0}recycleBullets(){const t=(s,i)=>{let n=0;for(let o=0;o<s.length;o+=1){const h=s[o];if((h==null?void 0:h.active)!==!1){s[n]=h,n+=1;continue}i.release(h)}s.length=n};t(this.p1Bullets,this.p1BulletPool),t(this.p2Bullets,this.p2BulletPool);let e=0;for(let s=0;s<this.bullets.length;s+=1){const i=this.bullets[s];(i==null?void 0:i.active)!==!1&&(this.bullets[e]=i,e+=1)}this.bullets.length=e}updateCameras(){this.p1Camera.follow(this.p1,ot),this.p2Camera.follow(this.p2,ot),this.p1Camera.update(),this.p2Camera.update(),this.clampCamera(this.p1Camera),this.clampCamera(this.p2Camera)}clampCamera(t){if(!t)return;const e=Math.max(0,this.worldWidth-t.viewportWidth);t.x=C(t.x,0,e),t.y=0}syncHudFromRoundManager(){var s,i,n,o;const t=((i=(s=this.roundManager)==null?void 0:s.getStats)==null?void 0:i.call(s,0))??{kills:0,deaths:0,dodges:0},e=((o=(n=this.roundManager)==null?void 0:n.getStats)==null?void 0:o.call(n,1))??{kills:0,deaths:0,dodges:0};this.versusHUD.setState(0,{bulletsDodged:t.dodges,deaths:t.deaths,kills:t.kills}),this.versusHUD.setState(1,{bulletsDodged:e.dodges,deaths:e.deaths,kills:e.kills})}getTerminalResult(){var u,c,y,p;const t=((c=(u=this.roundManager)==null?void 0:u.getStats)==null?void 0:c.call(u,0))??{kills:0,deaths:0,dodges:0},e=((p=(y=this.roundManager)==null?void 0:y.getStats)==null?void 0:p.call(y,1))??{kills:0,deaths:0,dodges:0},s=Math.max(0,Math.round(Number(t.kills)||0)),i=Math.max(0,Math.round(Number(e.kills)||0));if(s<this.killsToWin&&i<this.killsToWin)return null;const n=Math.max(0,Math.round(Number(t.deaths)||0)),o=Math.max(0,Math.round(Number(e.deaths)||0)),h=Math.max(0,Math.round(Number(t.dodges)||0)),a=Math.max(0,Math.round(Number(e.dodges)||0));let l=0;return s!==i?l=s>i?0:1:n!==o?l=n<o?0:1:h!==a&&(l=h>a?0:1),{winnerIndex:l,loserIndex:l===0?1:0,killsToWin:this.killsToWin,p1Kills:s,p2Kills:i,p1Deaths:n,p2Deaths:o,p1Dodges:h,p2Dodges:a}}finishMatch(t,e){var u;if(this.matchEnded)return;this.matchEnded=!0;const s=this.roundStartedAtMs>0?Math.max(0,Lt()-this.roundStartedAtMs):0,i=Math.floor(s/1e3),n=e.winnerIndex===0?e.p1Kills:e.p2Kills,o=e.winnerIndex===0?e.p1Deaths:e.p2Deaths,h=e.winnerIndex===0?e.p1Dodges:e.p2Dodges,a={mode:"versus",sourceScene:"versus",score:n,kills:n,deaths:o,dodges:h,wave:e.killsToWin,highScore:0,timeSeconds:i,winnerIndex:e.winnerIndex,loserIndex:e.loserIndex,killsToWin:e.killsToWin,p1Kills:e.p1Kills,p2Kills:e.p2Kills,p1Deaths:e.p1Deaths,p2Deaths:e.p2Deaths,p1Dodges:e.p1Dodges,p2Dodges:e.p2Dodges},l={winnerIndex:e.winnerIndex,loserIndex:e.loserIndex,killsToWin:e.killsToWin,p1Kills:e.p1Kills,p2Kills:e.p2Kills,p1Deaths:e.p1Deaths,p2Deaths:e.p2Deaths,p1Dodges:e.p1Dodges,p2Dodges:e.p2Dodges,timeSeconds:i};t.sceneData={...t.sceneData,mode:"versus",sourceScene:"versus",stats:a,versusResult:l},(u=t==null?void 0:t.switchScene)==null||u.call(t,"game_over",{mode:"versus",sourceScene:"versus",stats:a,versus:l})}render(t,e,s){const i=Math.max(1,Number(s==null?void 0:s.viewWidth)||this.width),n=Math.max(1,Number(s==null?void 0:s.viewHeight)||this.height),o=i*.5;t.fillStyle=us,t.fillRect(0,0,i,n),t.save(),t.beginPath(),t.rect(0,0,o,n),t.clip(),this.renderWorld(t,this.p1Camera,o,n),t.restore(),t.save(),t.beginPath(),t.rect(o,0,o,n),t.clip(),t.translate(o,0),this.renderWorld(t,this.p2Camera,o,n),t.restore();const h=Math.min(n,C(Math.round(n*An),Nn,En));t.fillStyle=In,t.fillRect(o-cs*.5,0,cs,h),this.versusHUD.render(t,i,n),this.muteButton.render(t,i,n)}renderWorld(t,e,s,i){var n,o;t.fillStyle=us,t.fillRect(0,0,s,i);for(const h of this.platforms)h.render(t,e);for(const h of this.bullets)(h==null?void 0:h.active)!==!1&&h.render(t,e);((n=this.p1)==null?void 0:n.active)!==!1&&this.p1.render(t,e),((o=this.p2)==null?void 0:o.active)!==!1&&this.p2.render(t,e)}handlePointerDown(t){const e=(t==null?void 0:t.id)??null;return e!==null&&this.muteButton.contains(t,this.width,this.height)?(this.mutePointerId=e,!0):this.versusInput.handlePointerDown(t,this.width)}handlePointerMove(t){return this.mutePointerId!==null&&(t==null?void 0:t.id)===this.mutePointerId?!0:this.versusInput.handlePointerMove(t,this.width)}handlePointerUp(t,e){var s,i,n,o,h,a;if(this.mutePointerId!==null&&(t==null?void 0:t.id)===this.mutePointerId){if(this.mutePointerId=null,!this.muteButton.handlePointerUp(t,this.width,this.height))return!0;const l=this.muteButton.isMuted(),u=!l,c=!l;return this.settings=me({soundEnabled:u,musicEnabled:c}),(i=(s=e==null?void 0:e.audioManager)==null?void 0:s.setEnabled)==null||i.call(s,u),(o=(n=e==null?void 0:e.musicManager)==null?void 0:n.setEnabled)==null||o.call(n,c),(a=(h=e==null?void 0:e.eventBus)==null?void 0:h.emit)==null||a.call(h,"ui_click",{source:"mute_toggle",muted:l}),!0}return this.versusInput.handlePointerUp(t)}handlePointerCancel(t){return this.mutePointerId!==null&&(t==null?void 0:t.id)===this.mutePointerId?(this.mutePointerId=null,!0):this.versusInput.handlePointerCancel(t)}}const Dt=ut;class Vn{constructor(){this.width=1,this.height=1,this.buttons=[],this.resumeButton=null,this.restartButton=null,this.menuButton=null,this.activePointerId=null,this.activeButton=null}onEnter(t,e){this.resumeButton=this.createButton("Resume",()=>{t.switchScene("game",{resume:!0})}),this.restartButton=this.createButton("Restart",()=>{t.switchScene("game",{restart:!0})}),this.menuButton=this.createButton("Menu",()=>{t.switchScene("menu")}),this.buttons=[this.resumeButton,this.restartButton,this.menuButton],this.activePointerId=null,this.activeButton=null,this.onResize(d(t==null?void 0:t.viewWidth,this.width),d(t==null?void 0:t.viewHeight,this.height),t)}onExit(t,e){this.activePointerId=null,this.activeButton=null;for(const s of this.buttons)this.setPressed(s,!1)}onResize(t,e,s){this.width=Math.max(1,d(t,1)),this.height=Math.max(1,d(e,1));const i=Math.min(320,Math.max(190,this.width*.3)),n=Math.min(70,Math.max(50,this.height*.08)),o=Math.max(14,this.height*.02),h=this.height*.42,a=(this.width-i)*.5;this.setButtonRect(this.resumeButton,a,h,i,n),this.setButtonRect(this.restartButton,a,h+n+o,i,n),this.setButtonRect(this.menuButton,a,h+(n+o)*2,i,n)}update(t,e){for(const s of this.buttons)S(s,["update"],[[t,e],[t],[]])}render(t,e,s){t.save(),t.fillStyle="rgba(4, 10, 22, 0.72)",t.fillRect(0,0,this.width,this.height);const i=Math.min(520,this.width*.72),n=Math.min(420,this.height*.68),o=(this.width-i)*.5,h=(this.height-n)*.5;t.fillStyle="rgba(13, 27, 52, 0.92)",t.strokeStyle="#6b87be",t.lineWidth=2,t.fillRect(o,h,i,n),t.strokeRect(o,h,i,n),t.fillStyle="#ecf2ff",t.textAlign="center",t.textBaseline="middle",t.font="700 48px Arial",t.fillText("PAUSED",this.width*.5,this.height*.28);for(const a of this.buttons)this.renderButton(t,a);t.restore()}handlePointerDown(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerDown",s,e))return!0;const n=this.findButtonAt(s);return n?(this.activePointerId=s.id,this.activeButton=n,this.setPressed(n,!0),!0):!1}handlePointerMove(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerMove",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=V(this.getButtonRect(this.activeButton),s);return this.setPressed(this.activeButton,n),!0}handlePointerUp(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerUp",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=this.activeButton,o=V(this.getButtonRect(n),s);return this.setPressed(n,!1),this.activePointerId=null,this.activeButton=null,o&&this.pressButton(n,e),!0}handlePointerCancel(t,e){const s=F(t);return(s?this.routePointer("handlePointerCancel",s,e):!1)?!0:this.activeButton?(this.setPressed(this.activeButton,!1),this.activeButton=null,this.activePointerId=null,!0):!1}createButton(t,e){let s=null;const i={label:t,text:t,onPress:e,onTap:e,onClick:e,x:0,y:0,width:0,height:0};if(typeof Dt=="function"){const n=[()=>new Dt(i),()=>new Dt(t,0,0,0,0,e),()=>new Dt(0,0,0,0,t,e)];for(const o of n)try{s=o();break}catch{}}return g(s)||(s={}),s.__sceneButton={label:t,onPress:e,pressed:!1,rect:{x:0,y:0,width:0,height:0}},s}setButtonRect(t,e,s,i,n){if(!g(t))return;const o={x:d(e,0),y:d(s,0),width:Math.max(0,d(i,0)),height:Math.max(0,d(n,0))};S(t,["setBounds","setRect","setFrame"],[[o.x,o.y,o.width,o.height],[o]]),S(t,["setPosition"],[[o.x,o.y]]),S(t,["setSize","resize"],[[o.width,o.height]]),"x"in t&&(t.x=o.x),"y"in t&&(t.y=o.y),"width"in t&&(t.width=o.width),"height"in t&&(t.height=o.height),g(t.bounds)&&(t.bounds.x=o.x,t.bounds.y=o.y,t.bounds.width=o.width,t.bounds.height=o.height),g(t.__sceneButton)&&(t.__sceneButton.rect=o)}getButtonRect(t){return g(t)?g(t.bounds)?{x:d(t.bounds.x,0),y:d(t.bounds.y,0),width:Math.max(0,d(t.bounds.width,0)),height:Math.max(0,d(t.bounds.height,0))}:g(t.__sceneButton)&&g(t.__sceneButton.rect)?t.__sceneButton.rect:{x:d(t.x,0),y:d(t.y,0),width:Math.max(0,d(t.width,0)),height:Math.max(0,d(t.height,0))}:{x:0,y:0,width:0,height:0}}setPressed(t,e){g(t)&&(S(t,["setPressed","setDown","setActive"],[[e]]),"pressed"in t&&(t.pressed=e),g(t.__sceneButton)&&(t.__sceneButton.pressed=e))}findButtonAt(t){for(let e=this.buttons.length-1;e>=0;e-=1){const s=this.buttons[e];if(V(this.getButtonRect(s),t))return s}return null}pressButton(t,e){S(t,["press","trigger","click","onPress","onTap","onClick"],[[e],[]]).called||g(t.__sceneButton)&&typeof t.__sceneButton.onPress=="function"&&t.__sceneButton.onPress(e)}renderButton(t,e){if(S(e,["render","draw"],[[t,this],[t]]).called)return;const i=this.getButtonRect(e),n=g(e.__sceneButton)?e.__sceneButton:null,o=!!(n!=null&&n.pressed);t.save(),t.fillStyle=o?"#5f3d3d":"#7b4f4f",t.strokeStyle="#f2d7d7",t.lineWidth=2,t.fillRect(i.x,i.y,i.width,i.height),t.strokeRect(i.x,i.y,i.width,i.height),t.fillStyle="#ffffff",t.textAlign="center",t.textBaseline="middle",t.font="700 24px Arial",t.fillText((n==null?void 0:n.label)??"Button",i.x+i.width*.5,i.y+i.height*.5),t.restore()}routePointer(t,e,s){const i=Ee(t);for(let n=this.buttons.length-1;n>=0;n-=1){const o=this.buttons[n],h=S(o,i,[[e,s],[e],[e.x,e.y,e.id]]);if(h.called&&h.value)return!0}return!1}}const zn={overlayColor:"rgba(3, 8, 18, 0.62)",panelFill:"rgba(13, 20, 35, 0.94)",panelStroke:"rgba(148, 171, 212, 0.78)",panelRadius:14,panelPaddingX:22,panelPaddingTop:18,panelPaddingBottom:18,titleColor:"#f3f8ff",labelColor:"#bfd0ea",valueColor:"#ffffff",helperColor:"#9fb3d4",titleFont:"700 28px Arial",rowFont:"600 18px Arial",helperFont:"500 14px Arial",rowHeight:30};class Re{constructor(t={}){const e=t&&typeof t=="object"?t:{};this.visible=e.visible!==!1,this.stats=e.stats&&typeof e.stats=="object"?{...e.stats}:{},this.title=typeof e.title=="string"?e.title:"GAME OVER",this.helperText=typeof e.helperText=="string"?e.helperText:"Tap to retry",this.style={...zn,...e.style&&typeof e.style=="object"?e.style:{}}}static formatValue(t){return Ne(t)}formatValue(t){return Re.formatValue(t)}setStats(t){this.stats=t&&typeof t=="object"?{...t}:{}}setVisible(t){this.visible=t!==!1}render(t,e){if(!this.visible||!t||typeof t.save!="function")return;const s=qt(t);if(s.width<=0||s.height<=0)return;const i=e&&typeof e=="object"?e:this.stats,n=this._buildRows(i),o=Math.min(420,Math.max(250,s.width-24)),h=this.style.panelPaddingTop+this.style.panelPaddingBottom+64+n.length*this.style.rowHeight+34,a=(s.width-o)*.5,l=(s.height-h)*.5;t.save(),t.fillStyle=this.style.overlayColor,t.fillRect(0,0,s.width,s.height),J(t,a,l,o,h,m(this.style.panelRadius,12)),t.fillStyle=this.style.panelFill,t.fill(),t.lineWidth=2,t.strokeStyle=this.style.panelStroke,t.stroke(),t.textAlign="center",t.textBaseline="middle",t.font=this.style.titleFont,t.fillStyle=this.style.titleColor,t.fillText(this.title,a+o*.5,l+32);const u=l+74;t.font=this.style.rowFont;for(let c=0;c<n.length;c+=1){const y=n[c],p=u+c*this.style.rowHeight;t.textAlign="left",t.fillStyle=this.style.labelColor,t.fillText(y.label,a+this.style.panelPaddingX,p),t.textAlign="right",t.fillStyle=this.style.valueColor,t.fillText(this.formatValue(y.value),a+o-this.style.panelPaddingX,p)}t.textAlign="center",t.fillStyle=this.style.helperColor,t.font=this.style.helperFont,t.fillText(this.helperText,a+o*.5,l+h-this.style.panelPaddingBottom-8),t.restore()}_buildRows(t){const e=[{label:"Score",value:N(t,["score"])},{label:"Wave",value:N(t,["wave","currentWave"])},{label:"Kills",value:N(t,["kills"])},{label:"Dodged",value:N(t,["dodges","dodged","bulletsDodged"])},{label:"Deaths",value:N(t,["deaths"])}],s=N(t,["hits"],NaN);Number.isFinite(s)&&e.push({label:"Hits",value:s});const i=N(t,["highScore","bestScore"],NaN);return Number.isFinite(i)&&e.splice(1,0,{label:"High Score",value:i}),e}}const Wt=ut,Ot=Re,ws="versus",O=r=>typeof r=="string"?r.trim().toLowerCase():"";function nt(r,t){if(!g(t))return r;for(const[e,s]of Object.entries(t))r[e]=s;return r}function Vs(r){const t=d(r.score,d(r.finalScore,d(r.points,0))),e=d(r.kills,d(r.enemiesKilled,0)),s=d(r.dodges,d(r.bulletsDodged,0)),i=d(r.wave,d(r.currentWave,d(r.waves,d(r.waveNumber,d(r.lastWave,0))))),n=d(r.deaths,d(r.playerDeaths,0)),o=d(r.highScore,d(r.bestScore,0)),h=d(r.timeSeconds,d(r.durationSeconds,d(r.time,0)));return{score:Math.max(0,Math.round(t)),kills:Math.max(0,Math.round(e)),dodges:Math.max(0,Math.round(s)),wave:Math.max(0,Math.round(i)),deaths:Math.max(0,Math.round(n)),highScore:Math.max(0,Math.round(o)),timeSeconds:Math.max(0,Math.round(h))}}function zs(r,t){var i;const e={};nt(e,r==null?void 0:r.sceneData),nt(e,(i=r==null?void 0:r.sceneData)==null?void 0:i.stats);const s=g(t==null?void 0:t.payload)?t.payload:t;return nt(e,s),nt(e,s==null?void 0:s.stats),nt(e,s==null?void 0:s.data),nt(e,s==null?void 0:s.event),e}function Kn(r,t){return Vs(zs(r,t))}function vs(r,t){const e=g(t==null?void 0:t.payload)?t.payload:t,s=g(e==null?void 0:e.stats)?e.stats:null,i=g(e==null?void 0:e.data)?e.data:null,n=g(e==null?void 0:e.event)?e.event:null,o=zs(r,t),h=[e==null?void 0:e.versus,e==null?void 0:e.versusResult,s==null?void 0:s.versus,s==null?void 0:s.versusResult,i==null?void 0:i.versus,i==null?void 0:i.versusResult,n==null?void 0:n.versus,n==null?void 0:n.versusResult];let a=null;for(const w of h)if(g(w)){a=w;break}const u=[O(e==null?void 0:e.mode),O(e==null?void 0:e.sourceMode),O(e==null?void 0:e.sourceScene),O(e==null?void 0:e.from),O(s==null?void 0:s.mode),O(s==null?void 0:s.sourceMode),O(s==null?void 0:s.sourceScene),O(i==null?void 0:i.mode),O(n==null?void 0:n.mode),O(t==null?void 0:t.from)].includes(ws)||g(a),c=Math.round(d(a==null?void 0:a.winnerIndex,d(o.winnerIndex,-1))),y=Math.round(d(a==null?void 0:a.loserIndex,d(o.loserIndex,-1))),p=d(a==null?void 0:a.killsToWin,d(o.killsToWin,-1));return{isVersus:u,mode:u?ws:"game",winnerIndex:c>=0?c:-1,loserIndex:y>=0?y:-1,killsToWin:p>=1?Math.round(p):null,p1Kills:Math.max(0,Math.round(d(a==null?void 0:a.p1Kills,d(o.p1Kills,0)))),p2Kills:Math.max(0,Math.round(d(a==null?void 0:a.p2Kills,d(o.p2Kills,0)))),p1Deaths:Math.max(0,Math.round(d(a==null?void 0:a.p1Deaths,d(o.p1Deaths,0)))),p2Deaths:Math.max(0,Math.round(d(a==null?void 0:a.p2Deaths,d(o.p2Deaths,0))))}}class Gn{constructor(){this.width=1,this.height=1,this.buttons=[],this.retryButton=null,this.menuButton=null,this.scoreBoard=null,this.stats=Vs({}),this.resultMeta=vs({},{}),this.titleText="GAME OVER",this.subtitleText="",this.scoreBoardRect={x:0,y:0,width:0,height:0},this.activePointerId=null,this.activeButton=null}onEnter(t,e){this.stats=Kn(t,e),this.resultMeta=vs(t,e),this.titleText=this.resultMeta.isVersus?"VERSUS RESULT":"GAME OVER",this.subtitleText=this.resultMeta.isVersus?this.getVersusSubtitle():"",this.retryButton=this.createButton("Retry",()=>{if(this.resultMeta.isVersus){t.switchScene("versus",{restart:!0});return}t.switchScene("game",{restart:!0})}),this.menuButton=this.createButton("Menu",()=>{t.switchScene("menu")}),this.buttons=[this.retryButton,this.menuButton],this.scoreBoard=this.createScoreBoard(this.stats),this.activePointerId=null,this.activeButton=null,this.onResize(d(t==null?void 0:t.viewWidth,this.width),d(t==null?void 0:t.viewHeight,this.height),t)}onExit(t,e){this.activePointerId=null,this.activeButton=null;for(const s of this.buttons)this.setPressed(s,!1)}onResize(t,e,s){this.width=Math.max(1,d(t,1)),this.height=Math.max(1,d(e,1));const i=Math.min(620,Math.max(280,this.width*.7)),n=Math.min(300,Math.max(180,this.height*.34)),o=(this.width-i)*.5,h=this.height*.24;this.setScoreBoardRect(o,h,i,n);const a=Math.min(240,Math.max(150,this.width*.24)),l=Math.min(66,Math.max(48,this.height*.075)),u=h+n+Math.max(16,this.height*.03);if(this.width>=560){const c=Math.max(16,this.width*.03),y=a*2+c,p=(this.width-y)*.5;this.setButtonRect(this.retryButton,p,u,a,l),this.setButtonRect(this.menuButton,p+a+c,u,a,l)}else{const c=(this.width-a)*.5,y=Math.max(12,this.height*.018);this.setButtonRect(this.retryButton,c,u,a,l),this.setButtonRect(this.menuButton,c,u+l+y,a,l)}}update(t,e){for(const s of this.buttons)S(s,["update"],[[t,e],[t],[]]);S(this.scoreBoard,["update"],[[t,e],[t],[]])}render(t,e,s){t.save();const i=t.createLinearGradient(0,0,0,this.height);i.addColorStop(0,"#311116"),i.addColorStop(1,"#12070a"),t.fillStyle=i,t.fillRect(0,0,this.width,this.height),t.fillStyle="#ffd7d7",t.textAlign="center",t.textBaseline="middle",t.font="700 52px Arial",t.fillText(this.titleText,this.width*.5,this.height*.13),this.subtitleText&&(t.fillStyle="#ffd7d7",t.font="600 24px Arial",t.fillText(this.subtitleText,this.width*.5,this.height*.18)),this.renderScoreBoard(t,s);for(const n of this.buttons)this.renderButton(t,n);t.restore()}handlePointerDown(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerDown",s,e))return!0;const n=this.findButtonAt(s);return n?(this.activePointerId=s.id,this.activeButton=n,this.setPressed(n,!0),!0):!1}handlePointerMove(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerMove",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=V(this.getButtonRect(this.activeButton),s);return this.setPressed(this.activeButton,n),!0}handlePointerUp(t,e){const s=F(t);if(!s)return!1;if(this.routePointer("handlePointerUp",s,e))return!0;if(this.activePointerId!==s.id||!this.activeButton)return!1;const n=this.activeButton,o=V(this.getButtonRect(n),s);return this.setPressed(n,!1),this.activePointerId=null,this.activeButton=null,o&&this.pressButton(n,e),!0}handlePointerCancel(t,e){const s=F(t);return(s?this.routePointer("handlePointerCancel",s,e):!1)?!0:this.activeButton?(this.setPressed(this.activeButton,!1),this.activeButton=null,this.activePointerId=null,!0):!1}createButton(t,e){let s=null;const i={label:t,text:t,onPress:e,onTap:e,onClick:e,x:0,y:0,width:0,height:0};if(typeof Wt=="function"){const n=[()=>new Wt(i),()=>new Wt(t,0,0,0,0,e),()=>new Wt(0,0,0,0,t,e)];for(const o of n)try{s=o();break}catch{}}return g(s)||(s={}),s.__sceneButton={label:t,onPress:e,pressed:!1,rect:{x:0,y:0,width:0,height:0}},s}createScoreBoard(t){let e=null;if(typeof Ot=="function"){const s=[()=>new Ot({stats:t}),()=>new Ot(t),()=>new Ot];for(const i of s)try{e=i();break}catch{}}return g(e)||(e={}),e.__sceneRect={x:0,y:0,width:0,height:0},this.applyScoreBoardStats(e,t),e}applyScoreBoardStats(t,e){S(t,["setStats","setData","setScoreData","setResult"],[[e]]),g(t)&&(t.stats=e,t.data=e)}setScoreBoardRect(t,e,s,i){this.scoreBoardRect={x:d(t,0),y:d(e,0),width:Math.max(0,d(s,0)),height:Math.max(0,d(i,0))},S(this.scoreBoard,["setBounds","setRect","setFrame"],[[this.scoreBoardRect.x,this.scoreBoardRect.y,this.scoreBoardRect.width,this.scoreBoardRect.height],[this.scoreBoardRect]]),S(this.scoreBoard,["setPosition"],[[this.scoreBoardRect.x,this.scoreBoardRect.y]]),S(this.scoreBoard,["setSize","resize"],[[this.scoreBoardRect.width,this.scoreBoardRect.height]]),g(this.scoreBoard)&&("x"in this.scoreBoard&&(this.scoreBoard.x=this.scoreBoardRect.x),"y"in this.scoreBoard&&(this.scoreBoard.y=this.scoreBoardRect.y),"width"in this.scoreBoard&&(this.scoreBoard.width=this.scoreBoardRect.width),"height"in this.scoreBoard&&(this.scoreBoard.height=this.scoreBoardRect.height),g(this.scoreBoard.bounds)&&(this.scoreBoard.bounds.x=this.scoreBoardRect.x,this.scoreBoard.bounds.y=this.scoreBoardRect.y,this.scoreBoard.bounds.width=this.scoreBoardRect.width,this.scoreBoard.bounds.height=this.scoreBoardRect.height),g(this.scoreBoard.__sceneRect)&&(this.scoreBoard.__sceneRect.x=this.scoreBoardRect.x,this.scoreBoard.__sceneRect.y=this.scoreBoardRect.y,this.scoreBoard.__sceneRect.width=this.scoreBoardRect.width,this.scoreBoard.__sceneRect.height=this.scoreBoardRect.height))}setButtonRect(t,e,s,i,n){if(!g(t))return;const o={x:d(e,0),y:d(s,0),width:Math.max(0,d(i,0)),height:Math.max(0,d(n,0))};S(t,["setBounds","setRect","setFrame"],[[o.x,o.y,o.width,o.height],[o]]),S(t,["setPosition"],[[o.x,o.y]]),S(t,["setSize","resize"],[[o.width,o.height]]),"x"in t&&(t.x=o.x),"y"in t&&(t.y=o.y),"width"in t&&(t.width=o.width),"height"in t&&(t.height=o.height),g(t.bounds)&&(t.bounds.x=o.x,t.bounds.y=o.y,t.bounds.width=o.width,t.bounds.height=o.height),g(t.__sceneButton)&&(t.__sceneButton.rect=o)}getButtonRect(t){return g(t)?g(t.bounds)?{x:d(t.bounds.x,0),y:d(t.bounds.y,0),width:Math.max(0,d(t.bounds.width,0)),height:Math.max(0,d(t.bounds.height,0))}:g(t.__sceneButton)&&g(t.__sceneButton.rect)?t.__sceneButton.rect:{x:d(t.x,0),y:d(t.y,0),width:Math.max(0,d(t.width,0)),height:Math.max(0,d(t.height,0))}:{x:0,y:0,width:0,height:0}}setPressed(t,e){g(t)&&(S(t,["setPressed","setDown","setActive"],[[e]]),"pressed"in t&&(t.pressed=e),g(t.__sceneButton)&&(t.__sceneButton.pressed=e))}findButtonAt(t){for(let e=this.buttons.length-1;e>=0;e-=1){const s=this.buttons[e];if(V(this.getButtonRect(s),t))return s}return null}pressButton(t,e){S(t,["press","trigger","click","onPress","onTap","onClick"],[[e],[]]).called||g(t.__sceneButton)&&typeof t.__sceneButton.onPress=="function"&&t.__sceneButton.onPress(e)}renderButton(t,e){if(S(e,["render","draw"],[[t,this],[t]]).called)return;const i=this.getButtonRect(e),n=g(e.__sceneButton)?e.__sceneButton:null,o=!!(n!=null&&n.pressed);t.save(),t.fillStyle=o?"#963434":"#ba4343",t.strokeStyle="#ffd9d9",t.lineWidth=2,t.fillRect(i.x,i.y,i.width,i.height),t.strokeRect(i.x,i.y,i.width,i.height),t.fillStyle="#ffffff",t.textAlign="center",t.textBaseline="middle",t.font="700 22px Arial",t.fillText((n==null?void 0:n.label)??"Button",i.x+i.width*.5,i.y+i.height*.5),t.restore()}renderScoreBoard(t,e){if(S(this.scoreBoard,["render","draw"],[[t,this.stats,e],[t,this.stats],[t]]).called)return;const i=this.scoreBoardRect,n=34,o=i.x+Math.max(20,i.width*.08),h=i.x+i.width-Math.max(20,i.width*.08),a=i.y+Math.max(34,i.height*.2);t.save(),t.fillStyle="rgba(40, 12, 16, 0.9)",t.strokeStyle="#dc9ca0",t.lineWidth=2,t.fillRect(i.x,i.y,i.width,i.height),t.strokeRect(i.x,i.y,i.width,i.height),t.fillStyle="#ffe9e9",t.textBaseline="middle",t.textAlign="left",t.font="600 24px Arial",t.fillText("Final Stats",o,i.y+30);const l=this.getScoreRows();t.font="500 21px Arial";for(let u=0;u<l.length;u+=1){const c=a+u*n;if(c>i.y+i.height-18)break;const[y,p]=l[u];t.fillStyle="#f3d0d0",t.textAlign="left",t.fillText(y,o,c),t.fillStyle="#ffffff",t.textAlign="right",t.fillText(String(p),h,c)}t.restore()}getVersusSubtitle(){const t=this.resultMeta.winnerIndex===0?"Player 1":this.resultMeta.winnerIndex===1?"Player 2":"Match",e=`${this.resultMeta.p1Kills}-${this.resultMeta.p2Kills}`;return`${t} wins (${e})`}getScoreRows(){if(this.resultMeta.isVersus){const e=[["Winner",this.resultMeta.winnerIndex===0?"Player 1":this.resultMeta.winnerIndex===1?"Player 2":"N/A"],["P1 Kills",this.resultMeta.p1Kills],["P2 Kills",this.resultMeta.p2Kills],["P1 Deaths",this.resultMeta.p1Deaths],["P2 Deaths",this.resultMeta.p2Deaths],["Time",`${this.stats.timeSeconds}s`]];return this.resultMeta.killsToWin!==null&&e.splice(1,0,["Target",this.resultMeta.killsToWin]),e}return[["Score",this.stats.score],["Kills",this.stats.kills],["Dodges",this.stats.dodges],["Wave",this.stats.wave],["Deaths",this.stats.deaths],["Time",`${this.stats.timeSeconds}s`],["High Score",this.stats.highScore]]}routePointer(t,e,s){const i=Ee(t);for(let n=this.buttons.length-1;n>=0;n-=1){const o=this.buttons[n],h=S(o,i,[[e,s],[e],[e.x,e.y,e.id]]);if(h.called&&h.value)return!0}return!1}}const $n="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=",qn=Object.freeze({pew:["sfx_shoot"],sfx_shoot:["pew"],hit:["sfx_hit"],sfx_hit:["hit"],explosion:["sfx_explosion"],sfx_explosion:["explosion"],whoosh:["sfx_whoosh"],sfx_whoosh:["whoosh"],fanfare:["sfx_fanfare"],sfx_fanfare:["fanfare"],ui_click:["sfx_click"],sfx_click:["ui_click"],jump:["sfx_jump"],sfx_jump:["jump"],death:["sfx_death"],sfx_death:["death"],menu_bgm:["bgm_menu"],bgm_menu:["menu_bgm"],battle_bgm:["bgm_battle"],bgm_battle:["battle_bgm"],pause_bgm:["bgm_pause"],bgm_pause:["pause_bgm"],game_over_bgm:["bgm_gameover","bgm_game_over"],bgm_gameover:["game_over_bgm","bgm_game_over"],bgm_game_over:["game_over_bgm","bgm_gameover"]});function Q(r){const t=Number(r);return Number.isFinite(t)?t<0?0:t>1?1:t:1}function _t(){return typeof Audio<"u"}function Ks(r){if(!_t()){r==null||r(!0);return}const t=new Audio($n);t.muted=!0,t.volume=0;let e=!1;const s=i=>{if(!e){e=!0;try{t.pause(),t.src=""}catch{}r==null||r(!!i)}};try{const i=t.play();i&&typeof i.then=="function"?i.then(()=>s(!0)).catch(()=>s(!1)):s(!0)}catch{s(!1)}}function Gs(r){const t=[r],e=[],s=new Set;for(;t.length>0;){const i=t.shift();if(typeof i!="string")continue;const n=i.trim();if(!n||s.has(n))continue;s.add(n),e.push(n);const o=qn[n];if(Array.isArray(o))for(const h of o)t.push(h)}return e}function $s(r,t){if(!t||typeof t!="object")return;const e=Gs(r);for(const s of e)if(Object.prototype.hasOwnProperty.call(t,s))return t[s]}function Qn(r,t,e="/audio"){const s=[],i=Gs(r);if(typeof t=="string")s.push(t);else if(t&&typeof t=="object"&&(typeof t.src=="string"&&s.push(t.src),typeof t.webm=="string"&&s.push(t.webm),typeof t.mp3=="string"&&s.push(t.mp3),Array.isArray(t.sources)))for(const h of t.sources)typeof h=="string"&&s.push(h);for(const h of i)s.push(`${e}/${h}.wav`),s.push(`${e}/${h}.webm`),s.push(`${e}/${h}.mp3`);const n=[],o=new Set;for(const h of s){if(typeof h!="string")continue;const a=h.trim();!a||o.has(a)||(o.add(a),n.push(a))}return n}function qs(r,t,e,s){const i=Qn(r,t,e);if(i.length===0)return null;for(let n=0;n<i.length;n+=1)if(!s||!s.has(n))return{index:n,src:i[n]};return null}const Jn=Object.freeze({bullet_fired:"sfx_shoot",player_hit:"sfx_hit",enemy_killed:"sfx_explosion",bullet_dodged:"sfx_whoosh",wave_cleared:"sfx_fanfare",ui_click:"sfx_click",versus_player_hit:"sfx_hit",versus_dodge:"sfx_whoosh",versus_kill:"sfx_explosion"});var _,be,Se,Qs,Js,_e,Pe,Me,Be,Te;class Zn{constructor(t,e={}){L(this,_);this.eventBus=t??null,this.enabled=e.enabled!==!1,this.volume=Q(e.volume??1),this.basePath=typeof e.basePath=="string"?e.basePath:"/audio",this.maxPoolSize=Number.isFinite(e.maxPoolSize)?Math.max(1,Math.floor(e.maxPoolSize)):6,this.sounds=e.sounds&&typeof e.sounds=="object"?e.sounds:{},this.eventSoundMap={...Jn,...e.eventSoundMap&&typeof e.eventSoundMap=="object"?e.eventSoundMap:{}},this.subscriptions=[],this.audioPools=new Map,this.failedSounds=new Set,this.failedSourceIndexes=new Map,this.missingAssetWarnings=new Set,this.pendingPlays=[],this.unlocked=e.unlocked===!0,this.disposed=!1}subscribe(){if(this.disposed)return this;if(this.unsubscribe(),!this.eventBus||typeof this.eventBus.on!="function")return this;const t=[["bullet_fired",()=>this.play(this.eventSoundMap.bullet_fired)],["player_hit",()=>this.play(this.eventSoundMap.player_hit)],["enemy_killed",()=>this.play(this.eventSoundMap.enemy_killed)],["bullet_dodged",()=>this.play(this.eventSoundMap.bullet_dodged)],["wave_cleared",()=>this.play(this.eventSoundMap.wave_cleared)],["versus:player_hit",()=>this.play(this.eventSoundMap.versus_player_hit)],["versus:dodge",()=>this.play(this.eventSoundMap.versus_dodge)],["versus:kill",()=>this.play(this.eventSoundMap.versus_kill)],["ui_click",()=>{this.unlock(),this.play(this.eventSoundMap.ui_click)}],["scene:switch",()=>this.unlock()]];for(const[e,s]of t){const i=this.eventBus.on(e,s);typeof i=="function"&&this.subscriptions.push(i)}return this}unsubscribe(){for(const t of this.subscriptions)try{t()}catch{}return this.subscriptions=[],this}unlock(){if(!(this.disposed||this.unlocked)){if(!_t()){this.unlocked=!0;return}Ks(t=>{this.disposed||!t||(this.unlocked=!0,f(this,_,Se).call(this))})}}play(t){if(this.disposed||!this.enabled||!t||!_t()||this.failedSounds.has(t))return!1;if(!this.unlocked)return f(this,_,be).call(this,t),!1;const e=f(this,_,Qs).call(this,t);let s=e.find(i=>i.paused||i.ended);if(!s&&e.length<this.maxPoolSize&&(s=f(this,_,Js).call(this,t),s&&e.push(s)),!s)return!1;s.volume=this.volume;try{s.currentTime=0}catch{}try{const i=s.play();return i&&typeof i.catch=="function"&&i.catch(n=>f(this,_,Be).call(this,t,s,n)),!0}catch(i){return f(this,_,Be).call(this,t,s,i),!1}}setEnabled(t){return this.enabled=!!t,this.enabled?this.unlocked&&f(this,_,Se).call(this):f(this,_,Te).call(this),this.enabled}setVolume(t){this.volume=Q(t);for(const e of this.audioPools.values())for(const s of e)s.volume=this.volume;return this.volume}dispose(){this.disposed||(this.disposed=!0,this.unsubscribe(),f(this,_,Te).call(this),this.audioPools.clear(),this.failedSounds.clear(),this.failedSourceIndexes.clear(),this.pendingPlays=[])}}_=new WeakSet,be=function(t){this.pendingPlays.length>=24&&this.pendingPlays.shift(),this.pendingPlays.push(t)},Se=function(){if(!this.enabled||!this.unlocked||this.pendingPlays.length===0)return;const t=this.pendingPlays.splice(0,this.pendingPlays.length);for(const e of t)this.play(e)},Qs=function(t){return this.audioPools.has(t)||this.audioPools.set(t,[]),this.audioPools.get(t)},Js=function(t){const e=f(this,_,_e).call(this,t);if(!e)return this.failedSounds.add(t),null;const s=new Audio(e.src);return s.preload="auto",s.volume=this.volume,s.__soundName=t,s.__sourceIndex=e.index,s.addEventListener("error",()=>{f(this,_,Pe).call(this,t,s.__sourceIndex)}),s},_e=function(t){const e=this.failedSourceIndexes.get(t),s=$s(t,this.sounds);return qs(t,s,this.basePath,e)},Pe=function(t,e){if(this.failedSounds.has(t)||!Number.isInteger(e))return;const s=this.failedSourceIndexes.get(t)??new Set;if(s.add(e),this.failedSourceIndexes.set(t,s),!f(this,_,_e).call(this,t)){this.failedSounds.add(t),this.missingAssetWarnings.has(t)||(this.missingAssetWarnings.add(t),console.warn(`[AudioManager] No playable sources resolved for sound "${t}".`)),f(this,_,Me).call(this,t);return}f(this,_,Me).call(this,t)},Me=function(t){const e=this.audioPools.get(t);if(e){for(const s of e){try{s.pause()}catch{}s.src=""}this.audioPools.delete(t)}},Be=function(t,e,s){if(s&&s.name==="NotAllowedError"){f(this,_,be).call(this,t);return}const i=e&&Number.isInteger(e.__sourceIndex)?e.__sourceIndex:null;f(this,_,Pe).call(this,t,i)},Te=function(){for(const t of this.audioPools.values())for(const e of t)try{e.pause(),e.currentTime=0}catch{}};const tr=Object.freeze({menu:"bgm_menu",game:"bgm_battle",versus:"bgm_battle",pause:"bgm_pause",game_over:"bgm_gameover"});function ue(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}var B,Zs,ti,Ie,rt,Ae,K;class er{constructor(t,e={}){L(this,B);this.eventBus=t??null,this.enabled=e.enabled!==!1,this.volume=Q(e.volume??1),this.basePath=typeof e.basePath=="string"?e.basePath:"/audio",this.tracks=e.tracks&&typeof e.tracks=="object"?e.tracks:{},this.sceneTrackMap={...tr,...e.sceneTrackMap&&typeof e.sceneTrackMap=="object"?e.sceneTrackMap:{}},this.subscriptions=[],this.failedTracks=new Set,this.failedSourceIndexes=new Map,this.missingAssetWarnings=new Set,this.currentTrack=null,this.currentAudio=null,this.pendingTrack=null,this.unlocked=e.unlocked===!0,this.fadeTimer=null,this.disposed=!1}subscribe(){if(this.disposed)return this;if(this.unsubscribe(),!this.eventBus||typeof this.eventBus.on!="function")return this;const t=s=>{this.unlock(),f(this,B,Zs).call(this,s)},e=[["ui_click",()=>this.unlock()],["scene:switch",t],["scene_enter",t],["game:stop",()=>this.stop()]];for(const[s,i]of e){const n=this.eventBus.on(s,i);typeof n=="function"&&this.subscriptions.push(n)}return this}unsubscribe(){for(const t of this.subscriptions)try{t()}catch{}return this.subscriptions=[],this}unlock(){if(!(this.disposed||this.unlocked)){if(!_t()){this.unlocked=!0;return}Ks(t=>{if(!(this.disposed||!t)&&(this.unlocked=!0,this.pendingTrack)){const e=this.pendingTrack;this.pendingTrack=null,this.play(e)}})}}play(t){if(this.disposed||!this.enabled||!t||!_t()||this.failedTracks.has(t))return!1;if(!this.unlocked)return this.pendingTrack=t,!1;if(this.currentTrack===t&&this.currentAudio){if(this.currentAudio.volume=this.volume,this.currentAudio.paused)try{const e=this.currentAudio.play();e&&typeof e.catch=="function"&&e.catch(s=>f(this,B,rt).call(this,t,this.currentAudio.__sourceIndex,s))}catch(e){f(this,B,rt).call(this,t,this.currentAudio.__sourceIndex,e)}return!0}return f(this,B,Ie).call(this,t)}stop(){if(f(this,B,K).call(this),!this.currentAudio){this.currentTrack=null;return}try{this.currentAudio.pause(),this.currentAudio.currentTime=0,this.currentAudio.src=""}catch{}this.currentAudio=null,this.currentTrack=null}fadeTo(t,e=300){const s=Q(t);if(!this.currentAudio){this.volume=s;return}f(this,B,K).call(this);const i=Number.isFinite(e)?Math.max(0,e):0;if(i===0){this.currentAudio.volume=s,this.volume=s;return}const n=this.currentAudio.volume,o=ue();if(typeof globalThis.requestAnimationFrame=="function"){const h=()=>{if(!this.currentAudio){f(this,B,K).call(this);return}const a=ue()-o,l=Math.min(1,a/i),u=n+(s-n)*l;if(this.currentAudio.volume=Q(u),l>=1){this.volume=s,f(this,B,K).call(this);return}this.fadeTimer={type:"raf",id:globalThis.requestAnimationFrame(h)}};this.fadeTimer={type:"raf",id:globalThis.requestAnimationFrame(h)};return}if(typeof globalThis.setInterval!="function"){this.currentAudio.volume=s,this.volume=s;return}this.fadeTimer={type:"interval",id:globalThis.setInterval(()=>{if(!this.currentAudio){f(this,B,K).call(this);return}const h=ue()-o,a=Math.min(1,h/i),l=n+(s-n)*a;this.currentAudio.volume=Q(l),a>=1&&(this.volume=s,f(this,B,K).call(this))},50)}}setEnabled(t){if(this.enabled=!!t,!this.enabled)return this.stop(),this.enabled;if(this.pendingTrack&&this.unlocked){const e=this.pendingTrack;this.pendingTrack=null,this.play(e)}return this.enabled}setVolume(t){return this.volume=Q(t),this.currentAudio&&(this.currentAudio.volume=this.volume),this.volume}dispose(){this.disposed||(this.disposed=!0,this.unsubscribe(),this.stop(),this.failedTracks.clear(),this.failedSourceIndexes.clear(),this.pendingTrack=null)}}B=new WeakSet,Zs=function(t){const e=f(this,B,ti).call(this,t);if(!e)return;const s=e.toLowerCase();if(s!=="menu"&&s!=="game"&&s!=="versus"&&s!=="pause"&&s!=="game_over")return;const i=this.sceneTrackMap[s];if(!i){s==="pause"&&this.fadeTo(Math.min(this.volume,.35),200);return}this.play(i)},ti=function(t){return typeof t=="string"?t:!t||typeof t!="object"?null:typeof t.name=="string"?t.name:typeof t.scene=="string"?t.scene:typeof t.to=="string"?t.to:t.to&&typeof t.to=="object"&&typeof t.to.name=="string"?t.to.name:null},Ie=function(t){const e=f(this,B,Ae).call(this,t);if(!e)return this.failedTracks.add(t),!1;f(this,B,K).call(this),this.stop();const s=new Audio(e.src);s.preload="auto",s.loop=!0,s.volume=this.volume,s.__trackName=t,s.__sourceIndex=e.index,s.addEventListener("error",()=>{f(this,B,rt).call(this,t,e.index,null)}),this.currentTrack=t,this.currentAudio=s;try{const i=s.play();return i&&typeof i.catch=="function"&&i.catch(n=>f(this,B,rt).call(this,t,e.index,n)),!0}catch(i){return f(this,B,rt).call(this,t,e.index,i),!1}},rt=function(t,e,s){if(s&&s.name==="NotAllowedError"){this.pendingTrack=t;return}if(!Number.isInteger(e))return;const i=this.failedSourceIndexes.get(t)??new Set;if(i.has(e))return;if(i.add(e),this.failedSourceIndexes.set(t,i),!f(this,B,Ae).call(this,t)){this.failedTracks.add(t),this.missingAssetWarnings.has(t)||(this.missingAssetWarnings.add(t),console.warn(`[MusicManager] No playable sources resolved for track "${t}".`)),this.currentTrack===t&&this.stop();return}this.currentTrack===t&&f(this,B,Ie).call(this,t)},Ae=function(t){const e=this.failedSourceIndexes.get(t),s=$s(t,this.tracks);return qs(t,s,this.basePath,e)},K=function(){if(this.fadeTimer!==null){if(typeof this.fadeTimer=="number"){typeof globalThis.clearInterval=="function"&&globalThis.clearInterval(this.fadeTimer),typeof globalThis.cancelAnimationFrame=="function"&&globalThis.cancelAnimationFrame(this.fadeTimer),this.fadeTimer=null;return}this.fadeTimer.type==="raf"&&typeof globalThis.cancelAnimationFrame=="function"?globalThis.cancelAnimationFrame(this.fadeTimer.id):this.fadeTimer.type==="interval"&&typeof globalThis.clearInterval=="function"&&globalThis.clearInterval(this.fadeTimer.id),this.fadeTimer=null}};function bs(){const r=document.getElementById("game-canvas");if(!(r instanceof HTMLCanvasElement))throw new Error('Expected a <canvas id="game-canvas"> element.');const t=new ci(r),e=bt(),s=new Zn(t.eventBus,{enabled:e.soundEnabled,volume:e.sfxVolume});s.subscribe();const i=new er(t.eventBus,{enabled:e.musicEnabled,volume:e.musicVolume});i.subscribe(),t.audioManager=s,t.musicManager=i,t.sceneData={},t.registerScene("menu",new bi),t.registerScene("game",new on),t.registerScene("versus",new Xn),t.registerScene("pause",new Vn),t.registerScene("game_over",new Gn),t.switchScene("menu",{restart:!0}),t.start(),window.addEventListener("beforeunload",()=>{s.dispose(),i.dispose()},{once:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",bs,{once:!0}):bs();
